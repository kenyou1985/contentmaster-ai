import React, { useState } from 'react';
import { ToolMode, NicheType, ApiProvider } from '../types';
import { NICHES } from '../constants';
import { streamContentGeneration, initializeGemini } from '../services/geminiService';
import { FileText, Maximize2, RefreshCw, Scissors, ArrowRight, Copy, ChevronDown, Video } from 'lucide-react';

interface ToolsProps {
  apiKey: string;
  provider: ApiProvider;
}

export const Tools: React.FC<ToolsProps> = ({ apiKey, provider }) => {
  const [mode, setMode] = useState<ToolMode>(ToolMode.REWRITE);
  const [niche, setNiche] = useState<NicheType>(NicheType.TCM_METAPHYSICS); // Niche awareness
  const [inputText, setInputText] = useState('');
  const [outputText, setOutputText] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);

  // æ¸…ç†Markdownæ ¼å¼ç¬¦å·ï¼Œè¾“å‡ºçº¯æ–‡æœ¬ï¼ˆä¿ç•™ç¼–å·æ ¼å¼ï¼‰
  const cleanMarkdownFormat = (text: string, mode?: ToolMode): string => {
    if (!text) return '';
    let cleaned = text
      // ç§»é™¤Markdownæ ‡é¢˜æ ‡è®°
      .replace(/^#{1,6}\s+/gm, '')
      // ç§»é™¤æ‰€æœ‰Markdownç‰¹æ®Šç¬¦å·
      .replace(/\*\*/g, '') // ç§»é™¤ **ç²—ä½“**
      .replace(/\*/g, '') // ç§»é™¤ *æ–œä½“*ï¼ˆä½†è¦ä¿ç•™ç¼–å·ä¸­çš„ç‚¹ï¼Œæ‰€ä»¥å…ˆå¤„ç†**ï¼‰
      .replace(/__/g, '') // ç§»é™¤ __ç²—ä½“__
      .replace(/_/g, '') // ç§»é™¤ _æ–œä½“_
      .replace(/~~/g, '') // ç§»é™¤ ~~åˆ é™¤çº¿~~
      .replace(/~/g, '') // ç§»é™¤ ~åˆ é™¤çº¿~
      .replace(/`/g, '') // ç§»é™¤ `ä»£ç `
      .replace(/<[^>]+>/g, ''); // ç§»é™¤HTMLæ ‡ç­¾
    
    // å¯¹äºè„šæœ¬æ¨¡å¼ï¼Œä¿ç•™æ–¹æ‹¬å·æ ¼å¼ï¼ˆå¦‚[åºè™Ÿ]ã€[åç¨±]ç­‰ï¼‰
    if (mode === ToolMode.SCRIPT) {
      // ä¿ç•™æ–¹æ‹¬å·æ ¼å¼ï¼Œåªç§»é™¤é“¾æ¥æ ¼å¼
      cleaned = cleaned.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1'); // ç§»é™¤é“¾æ¥æ ¼å¼ï¼Œä¿ç•™æ–‡æœ¬
      // ä¸ç§»é™¤æ–¹æ‹¬å·æ ¼å¼ï¼Œä¿ç•™[åºè™Ÿ]ã€[åç¨±]ç­‰
    } else {
      // å…¶ä»–æ¨¡å¼ç§»é™¤æ–¹æ‹¬å·æ ¼å¼
      cleaned = cleaned
        .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1') // ç§»é™¤é“¾æ¥æ ¼å¼ï¼Œä¿ç•™æ–‡æœ¬
        .replace(/\[([^\]]+)\]/g, '$1'); // ç§»é™¤å¼•ç”¨é“¾æ¥æ ¼å¼
    }
    
    // ç§»é™¤æ— åºåˆ—è¡¨æ ‡è®°ï¼ˆä¿ç•™ç¼–å·æ ¼å¼ï¼‰
    cleaned = cleaned.replace(/^\s*[-*+â€¢]\s+/gm, '');
    
    // å¯¹äºæ‘˜è¦æ¨¡å¼ï¼Œä¿ç•™ç¼–å·æ ¼å¼ï¼ˆ1. 2. 3.ç­‰ï¼‰
    if (mode === ToolMode.SUMMARIZE) {
      // ä¸ç§»é™¤ç¼–å·ï¼Œåªæ¸…ç†å…¶ä»–æ ¼å¼
    } else if (mode !== ToolMode.SCRIPT) {
      // è„šæœ¬æ¨¡å¼ä¹Ÿä¿ç•™ç¼–å·æ ¼å¼ï¼ˆé•œå¤´åºå·ï¼‰
      // å…¶ä»–æ¨¡å¼ç§»é™¤ç¼–å·æ ¼å¼
      cleaned = cleaned.replace(/^\s*\d+\.\s+/gm, '');
    }
    
    return cleaned
      // æ¸…ç†å¤šä½™ç©ºè¡Œ
      .replace(/\n\s*\n\s*\n+/g, '\n\n')
      .trim();
  };

  // æ£€æŸ¥æ˜¯å¦æœ‰æå‰çš„æ”¶å°¾è¯ï¼ˆå­—æ•°ä¸è¶³æ—¶ä¸åº”è¯¥å‡ºç°ï¼‰
  const hasPrematureEnding = (text: string): boolean => {
    const endingKeywords = [
      /ä¸‹èª²/i,
      /ä¸‹è¯¾/i,
      /æ•£æœƒ/i,
      /æ•£ä¼š/i,
      /ä¸‹æœŸå†è¦‹/i,
      /ä¸‹æœŸå†è§/i,
      /ä»Šå¤©å°±åˆ°é€™/i,
      /ä»Šå¤©å°±åˆ°è¿™/i,
      /å’±å€‘ä¸‹æ¬¡/i,
      /å’±ä»¬ä¸‹æ¬¡/i,
    ];
    return endingKeywords.some(pattern => pattern.test(text));
  };

  // æ£€æµ‹å¹¶æ¸…ç†ä¸å®Œæ•´çš„é•œå¤´ï¼ˆè„šæœ¬æ¨¡å¼ä¸“ç”¨ï¼‰
  const cleanIncompleteShot = (text: string): { cleaned: string; lastShotNumber: number; needsRework: boolean } => {
    // åŒ¹é…é•œå¤´æ ¼å¼ï¼šé•œå¤´[æ•°å­—] æˆ– é¡é ­[æ•°å­—]
    const shotPattern = /(?:é•œå¤´|é¡é ­)(\d+)/g;
    const shots: Array<{ number: number; startIndex: number }> = [];
    let match;
    const shotMatches: RegExpExecArray[] = [];
    
    // æ”¶é›†æ‰€æœ‰é•œå¤´åŒ¹é…
    while ((match = shotPattern.exec(text)) !== null) {
      shotMatches.push(match);
      shots.push({ 
        number: parseInt(match[1]), 
        startIndex: match.index 
      });
    }
    
    if (shots.length === 0) {
      return { cleaned: text, lastShotNumber: 0, needsRework: false };
    }
    
    // æ£€æŸ¥æœ€åä¸€ä¸ªé•œå¤´æ˜¯å¦å®Œæ•´
    const lastShot = shots[shots.length - 1];
    const lastShotStart = lastShot.startIndex;
    // æŸ¥æ‰¾æœ€åä¸€ä¸ªé•œå¤´çš„ç»“æŸä½ç½®ï¼ˆä¸‹ä¸€ä¸ªé•œå¤´å¼€å§‹æˆ–æ–‡æœ¬æœ«å°¾ï¼‰
    let lastShotEnd = text.length;
    // æ£€æŸ¥æ˜¯å¦æœ‰è§’è‰²ä¿¡æ¯æˆ–åœºæ™¯ä¿¡æ¯å¼€å§‹
    const roleInfoIndex = text.indexOf('[è§’è‰²ä¿¡æ¯]', lastShotStart);
    const sceneInfoIndex = text.indexOf('[åœºæ™¯ä¿¡æ¯]', lastShotStart);
    const sceneInfoIndex2 = text.indexOf('[å ´æ™¯ä¿¡æ¯]', lastShotStart);
    
    if (roleInfoIndex > lastShotStart && roleInfoIndex < lastShotEnd) {
      lastShotEnd = roleInfoIndex;
    }
    if (sceneInfoIndex > lastShotStart && sceneInfoIndex < lastShotEnd) {
      lastShotEnd = sceneInfoIndex;
    }
    if (sceneInfoIndex2 > lastShotStart && sceneInfoIndex2 < lastShotEnd) {
      lastShotEnd = sceneInfoIndex2;
    }
    
    const lastShotContent = text.substring(lastShotStart, lastShotEnd);
    
    // æ£€æŸ¥æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µï¼ˆæ”¯æŒç¹ä½“å’Œç®€ä½“ï¼‰
    const requiredFields = [
      { zh: 'é•œå¤´æ–‡æ¡ˆ', tw: 'é¡é ­æ–‡æ¡ˆ' },
      { zh: 'å›¾ç‰‡æç¤ºè¯', tw: 'åœ–ç‰‡æç¤ºè©' },
      { zh: 'è§†é¢‘æç¤ºè¯', tw: 'è¦–é »æç¤ºè©' },
      { zh: 'æ™¯åˆ«', tw: 'æ™¯åˆ¥' },
      { zh: 'è¯­éŸ³åˆ†é•œ', tw: 'èªéŸ³åˆ†é¡' },
      { zh: 'éŸ³æ•ˆ', tw: 'éŸ³æ•ˆ' }
    ];
    
    const hasAllFields = requiredFields.every(field => 
      lastShotContent.includes(field.zh) || lastShotContent.includes(field.tw)
    );
    
    // æ£€æŸ¥æœ€åä¸€ä¸ªå­—æ®µï¼ˆéŸ³æ•ˆï¼‰æ˜¯å¦å®Œæ•´ï¼ˆæœ‰å€¼ï¼Œä¸æ˜¯ç©ºè¡Œï¼‰
    const hasCompleteLastField = /éŸ³æ•ˆ:\s*[^\n\r]+/.test(lastShotContent) || /éŸ³æ•ˆ:\s*[^\n\r]+/.test(lastShotContent);
    
    // æ£€æŸ¥é•œå¤´å†…å®¹æ˜¯å¦è¢«æˆªæ–­ï¼ˆå¦‚æœæœ€åä¸€ä¸ªé•œå¤´å†…å®¹å¾ˆçŸ­ï¼Œå¯èƒ½è¢«æˆªæ–­ï¼‰
    const isTruncated = lastShotContent.length < 100; // å¦‚æœæœ€åä¸€ä¸ªé•œå¤´å†…å®¹å°‘äº100å­—ç¬¦ï¼Œå¯èƒ½è¢«æˆªæ–­
    
    if (!hasAllFields || !hasCompleteLastField || isTruncated) {
      // åˆ é™¤ä¸å®Œæ•´çš„æœ€åä¸€ä¸ªé•œå¤´
      const cleaned = text.substring(0, lastShotStart).trim();
      return { cleaned, lastShotNumber: lastShot.number, needsRework: true };
    }
    
    return { cleaned: text, lastShotNumber: lastShot.number, needsRework: false };
  };

  // æ£€æŸ¥å†…å®¹æ˜¯å¦å®Œæ•´ï¼ˆæ˜¯å¦æœ‰æ˜ç¡®çš„ç»“å°¾ï¼‰
  const isContentComplete = (text: string, mode: ToolMode, originalLength: number): boolean => {
    if (mode === ToolMode.SUMMARIZE) {
      // æ‘˜è¦æ¨¡å¼ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ ‡ç­¾éƒ¨åˆ†ï¼ˆè¡¨ç¤ºå®Œæ•´è¾“å‡ºï¼‰
      return text.includes('ç†±é–€æ¨™ç±¤') || text.includes('#');
    }
    
    if (mode === ToolMode.SCRIPT) {
      // è„šæœ¬æ¨¡å¼ï¼šæ£€æŸ¥æ˜¯å¦åŒ…å«è§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯ï¼Œä»¥åŠé•œå¤´æ•°é‡
      const hasRoleInfo = text.includes('[è§’è‰²ä¿¡æ¯]') || text.includes('[è§’è‰²ä¿¡æ¯]');
      const hasSceneInfo = text.includes('[å ´æ™¯ä¿¡æ¯]') || text.includes('[åœºæ™¯ä¿¡æ¯]');
      // æ£€æŸ¥é•œå¤´æ•°é‡ï¼ˆæ”¯æŒç¹ä½“å’Œç®€ä½“ï¼‰
      const shotCount = (text.match(/é¡é ­\d+|é•œå¤´\d+/g) || []).length;
      // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„æ ‡è®°ï¼ˆ------è¡¨ç¤ºè¿˜éœ€è¦ç»­å†™ï¼‰
      const hasIncompleteMarker = text.includes('------');
      
      // å¦‚æœé•œå¤´æ•°é‡ä¸º0ï¼Œè¯´æ˜è¿˜æ²¡å¼€å§‹è¾“å‡ºï¼Œä¸ç®—å®Œæ•´
      if (shotCount === 0) return false;
      
      // å¦‚æœæ£€æµ‹åˆ°è§’è‰²ä¿¡æ¯æˆ–åœºæ™¯ä¿¡æ¯ï¼Œä½†è¿˜æœ‰æœªå®Œæˆæ ‡è®°ï¼Œè¯´æ˜ä¸å®Œæ•´
      if (hasIncompleteMarker) return false;
      
      // æ£€æŸ¥æœ€åä¸€ä¸ªé•œå¤´æ˜¯å¦å®Œæ•´ï¼ˆå¦‚æœæœ€åä¸€ä¸ªé•œå¤´ä¸å®Œæ•´ï¼Œå³ä½¿æœ‰è§’è‰²ä¿¡æ¯ä¹Ÿä¸ç®—å®Œæ•´ï¼‰
      const { needsRework } = cleanIncompleteShot(text);
      if (needsRework) return false;
      
      // å¦‚æœæ£€æµ‹åˆ°è§’è‰²ä¿¡æ¯æˆ–åœºæ™¯ä¿¡æ¯ï¼Œæ£€æŸ¥å®ƒä»¬æ˜¯å¦å‡ºç°åœ¨æ‰€æœ‰é•œå¤´å®Œæˆä¹‹å
      if (hasRoleInfo || hasSceneInfo) {
        // æ‰¾åˆ°æœ€åä¸€ä¸ªé•œå¤´çš„ç»“æŸä½ç½®
        const lastShotMatch = text.match(/(?:é•œå¤´|é¡é ­)(\d+)/g);
        if (lastShotMatch && lastShotMatch.length > 0) {
          const lastShotNumber = parseInt(lastShotMatch[lastShotMatch.length - 1].replace(/(?:é•œå¤´|é¡é ­)/, ''));
          const lastShotPattern = new RegExp(`(?:é•œå¤´|é¡é ­)${lastShotNumber}[\\s\\S]*?(?=\\[è§’è‰²ä¿¡æ¯\\]|\\[åœºæ™¯ä¿¡æ¯\\]|\\[å ´æ™¯ä¿¡æ¯\\]|$)`, 'i');
          const lastShotSection = text.match(lastShotPattern);
          
          // æ£€æŸ¥æœ€åä¸€ä¸ªé•œå¤´éƒ¨åˆ†æ˜¯å¦å®Œæ•´ï¼ˆåŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µï¼‰
          if (lastShotSection) {
            const lastShotContent = lastShotSection[0];
            const requiredFields = [
              { zh: 'é•œå¤´æ–‡æ¡ˆ', tw: 'é¡é ­æ–‡æ¡ˆ' },
              { zh: 'å›¾ç‰‡æç¤ºè¯', tw: 'åœ–ç‰‡æç¤ºè©' },
              { zh: 'è§†é¢‘æç¤ºè¯', tw: 'è¦–é »æç¤ºè©' },
              { zh: 'æ™¯åˆ«', tw: 'æ™¯åˆ¥' },
              { zh: 'è¯­éŸ³åˆ†é•œ', tw: 'èªéŸ³åˆ†é¡' },
              { zh: 'éŸ³æ•ˆ', tw: 'éŸ³æ•ˆ' }
            ];
            const hasAllFields = requiredFields.every(field => 
              lastShotContent.includes(field.zh) || lastShotContent.includes(field.tw)
            );
            const hasCompleteLastField = /éŸ³æ•ˆ:\s*[^\n\r]+/.test(lastShotContent);
            
            // å¦‚æœæœ€åä¸€ä¸ªé•œå¤´ä¸å®Œæ•´ï¼Œå³ä½¿æœ‰è§’è‰²ä¿¡æ¯ä¹Ÿä¸ç®—å®Œæ•´
            if (!hasAllFields || !hasCompleteLastField) return false;
          }
        }
      }
      
      // è„šæœ¬å®Œæ•´éœ€è¦ï¼šæœ‰è§’è‰²ä¿¡æ¯ã€æœ‰åœºæ™¯ä¿¡æ¯ã€é•œå¤´æ•°é‡åˆç†ï¼ˆä¸è¶…è¿‡60ä¸ªï¼‰ã€æ²¡æœ‰æœªå®Œæˆæ ‡è®°ã€æ‰€æœ‰é•œå¤´éƒ½å®Œæ•´
      return hasRoleInfo && hasSceneInfo && shotCount > 0 && shotCount <= 60;
    }
    
    // å…¶ä»–æ¨¡å¼ï¼šæ£€æŸ¥å­—æ•°å’Œç»“å°¾å®Œæ•´æ€§
    const length = text.length;
    const hasProperEnding = /[ã€‚ï¼ï¼Ÿ.!?]$/.test(text.trim()); // ä»¥æ ‡ç‚¹ç»“å°¾
    const notTruncated = !text.endsWith('...') && !text.endsWith('â€¦');
    
    if (mode === ToolMode.REWRITE || mode === ToolMode.POLISH) {
      // æ”¹å†™å’Œæ¶¦è‰²ï¼šå¿…é¡»å­—æ•°>=åŸæ–‡çš„90%æ‰è®¤ä¸ºå®Œæ•´
      // å¦‚æœå­—æ•°ä¸è¶³ä½†å‡ºç°äº†æ”¶å°¾è¯ï¼Œè¯´æ˜æå‰ç»“æŸäº†ï¼Œéœ€è¦ç»§ç»­
      const reachedMinimum = length >= originalLength * 0.9;
      const reachedTarget = length >= originalLength * 0.95;
      
      // å¦‚æœå­—æ•°ä¸è¶³90%ï¼Œå³ä½¿æœ‰æ”¶å°¾æ ‡ç‚¹ä¹Ÿä¸ç®—å®Œæ•´
      if (!reachedMinimum) {
        return false;
      }
      
      // å­—æ•°è¾¾åˆ°90-95%ï¼Œä¸”æœ‰æ ‡ç‚¹ç»“å°¾ï¼Œæ‰ç®—å®Œæ•´
      return reachedTarget && hasProperEnding && notTruncated;
    } else if (mode === ToolMode.EXPAND) {
      // æ‰©å†™ï¼šå¿…é¡»å­—æ•°>=1.4å€æ‰è®¤ä¸ºæ¥è¿‘å®Œæˆ
      const reachedMinimum = length >= originalLength * 1.4;
      const reachedTarget = length >= originalLength * 1.5;
      
      if (!reachedMinimum) {
        return false;
      }
      
      return reachedTarget && hasProperEnding && notTruncated;
    }
    
    return hasProperEnding && notTruncated;
  };

  // æ£€æµ‹æ˜¯å¦ä¸ºYouTubeé“¾æ¥
  const isYouTubeLink = (text: string): boolean => {
    const youtubePatterns = [
      /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
      /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/,
    ];
    return youtubePatterns.some(pattern => pattern.test(text));
  };

  // æå–YouTubeè§†é¢‘ID
  const extractYouTubeVideoId = (url: string): string | null => {
    const patterns = [
      /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
      /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/,
    ];
    for (const pattern of patterns) {
      const match = url.match(pattern);
      if (match) return match[1];
    }
    return null;
  };

  const handleAction = async () => {
    if (!apiKey || !inputText) return;
    
    setIsGenerating(true);
    setOutputText('');

    const nicheConfig = NICHES[niche];
    let localOutput = '';
    const MAX_CONTINUATIONS = 5; // æœ€å¤§ç»­å†™æ¬¡æ•°
    let continuationCount = 0;
    
    // æ£€æµ‹æ˜¯å¦ä¸ºYouTubeé“¾æ¥
    const isYouTube = isYouTubeLink(inputText.trim());
    const videoId = isYouTube ? extractYouTubeVideoId(inputText.trim()) : null;
    
    // å¦‚æœåªæœ‰ YouTube é“¾æ¥ï¼Œæ²¡æœ‰å…¶ä»–æ–‡æœ¬å†…å®¹ï¼Œç›´æ¥æç¤ºç”¨æˆ·
    if (isYouTube && videoId) {
      const textWithoutLink = inputText.trim().replace(/https?:\/\/(www\.)?(youtube\.com|youtu\.be)[^\s]*/gi, '').trim();
      
      // å¦‚æœç§»é™¤é“¾æ¥åæ²¡æœ‰å…¶ä»–æ–‡æœ¬ï¼Œè¯´æ˜åªæœ‰é“¾æ¥
      if (!textWithoutLink || textWithoutLink.length < 10) {
        setIsGenerating(false);
        setOutputText(`ğŸ“º YouTube è¦–é »è™•ç†æŒ‡å—\n\næª¢æ¸¬åˆ°æ‚¨è¼¸å…¥çš„æ˜¯ YouTube è¦–é »éˆæ¥ï¼š\n${inputText.trim()}\n\n---\n\nâš ï¸ **ç‚ºä»€éº¼éœ€è¦æ‰‹å‹•è¤‡è£½å­—å¹•ï¼Ÿ**\n\nç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼ˆCORS æ”¿ç­–ï¼‰å’Œ YouTube çš„ API è¦æ±‚ï¼Œå‰ç«¯æ‡‰ç”¨ç„¡æ³•ç›´æ¥è¨ªå• YouTube è¦–é »çš„è½‰éŒ„å…§å®¹ã€‚è¦å¯¦ç¾è‡ªå‹•æå–éœ€è¦ï¼š\n\nâ€¢ å¾Œç«¯æœå‹™å™¨ï¼ˆè™•ç† CORS å’Œ API èªè­‰ï¼‰\nâ€¢ YouTube Data API v3 æˆæ¬Š\nâ€¢ OAuth 2.0 èªè­‰æµç¨‹\n\nå› æ­¤ï¼Œç›®å‰æœ€ç°¡å–®å¯é çš„æ–¹å¼æ˜¯æ‰‹å‹•è¤‡è£½å­—å¹•ã€‚\n\n---\n\nğŸ“‹ **æ“ä½œæ­¥é©Ÿ**\n\n1ï¸âƒ£ **ç²å–è¦–é »è½‰éŒ„æ–‡æœ¬**\n   â€¢ æ‰“é–‹ä¸Šè¿° YouTube è¦–é »\n   â€¢ é»æ“Šè¦–é »ä¸‹æ–¹çš„ã€Œâ‹¯ã€èœå–®\n   â€¢ é¸æ“‡ã€Œé¡¯ç¤ºè½‰éŒ„ã€æˆ–ã€Œå­—å¹•ã€\n   â€¢ è¤‡è£½å®Œæ•´çš„è½‰éŒ„æ–‡æœ¬ï¼ˆå¯ä»¥å…¨é¸è¤‡è£½ï¼‰\n\n2ï¸âƒ£ **ç²˜è²¼è½‰éŒ„æ–‡æœ¬**\n   â€¢ å°‡è½‰éŒ„æ–‡æœ¬ç²˜è²¼åˆ°ã€ŒåŸå§‹æ–‡æœ¬ã€è¼¸å…¥æ¡†\n   â€¢ å¯ä»¥ä¿ç•™æˆ–åˆªé™¤ YouTube éˆæ¥ï¼ˆç³»çµ±æœƒè‡ªå‹•è­˜åˆ¥ï¼‰\n   â€¢ é¸æ“‡è™•ç†æ¨¡å¼ï¼ˆæ”¹å¯«/æ“´å¯«/æ‘˜è¦/æ½¤è‰²ï¼‰\n\n3ï¸âƒ£ **é–‹å§‹è™•ç†**\n   â€¢ é»æ“Šç”ŸæˆæŒ‰éˆ•\n   â€¢ ç³»çµ±æœƒæ ¹æ“šæ‚¨é¸æ“‡çš„æ¨¡å¼è™•ç†æ–‡æœ¬\n\n---\n\nğŸ’¡ **å°æŠ€å·§**\nâ€¢ å¦‚æœè¦–é »æœ‰è‡ªå‹•ç”Ÿæˆçš„å­—å¹•ï¼Œé€šå¸¸è³ªé‡ä¹Ÿå¾ˆå¥½\nâ€¢ å¯ä»¥å°‡éˆæ¥å’Œæ–‡æœ¬ä¸€èµ·ç²˜è²¼ï¼Œç³»çµ±æœƒè‡ªå‹•è­˜åˆ¥ä¸¦è™•ç†æ–‡æœ¬\nâ€¢ è¤‡è£½æ™‚å¯ä»¥åŒ…å«æ™‚é–“æˆ³ï¼Œç³»çµ±æœƒè‡ªå‹•éæ¿¾\n\nğŸ”® **æœªä¾†æ”¹é€²**\nå¦‚æœå¾ŒçºŒæ·»åŠ å¾Œç«¯æœå‹™æ”¯æŒï¼Œå°‡å¯ä»¥å¯¦ç¾ä¸€éµè‡ªå‹•æå–åŠŸèƒ½ã€‚`);
        return;
      }
    }
    
    // Inject Niche Persona into the system instruction, enforce Chinese
    let systemInstruction = `${nicheConfig.systemInstruction}\nä½ ä¹Ÿæ˜¯ä¸€ä½å°ˆæ¥­çš„å…§å®¹ç·¨è¼¯ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡è¼¸å‡ºã€‚`;
    
    // å¦‚æœæ˜¯YouTubeé“¾æ¥ï¼ˆä¸”æœ‰æ–‡æœ¬å†…å®¹ï¼‰ï¼Œæ·»åŠ ç‰¹æ®Šè¯´æ˜
    if (isYouTube && videoId) {
      systemInstruction += `\n\nâš ï¸ é‡è¦æç¤ºï¼šç”¨æˆ¶æä¾›äº†ä¸€å€‹ YouTube è¦–é »éˆæ¥ï¼ˆè¦–é »ID: ${videoId}ï¼‰ï¼ŒåŒæ™‚ä¹Ÿæä¾›äº†è½‰éŒ„æ–‡æœ¬ã€‚è«‹ç›´æ¥è™•ç†è½‰éŒ„æ–‡æœ¬å…§å®¹ï¼Œå¿½ç•¥éˆæ¥éƒ¨åˆ†ã€‚`;
    }
    
    const originalLength = inputText.length;

    // ç”Ÿæˆåˆå§‹promptçš„å‡½æ•°
    const generateInitialPrompt = (mode: ToolMode, originalLength: number): string => {
        const inputSection = isYouTube && videoId 
            ? `## Input Data
âš ï¸ **æª¢æ¸¬åˆ° YouTube è¦–é »éˆæ¥**ï¼ˆè¦–é »ID: ${videoId}ï¼‰

${inputText}

**æ³¨æ„**ï¼šä¸Šè¿°è¼¸å…¥åŒ…å« YouTube è¦–é »éˆæ¥å’Œè½‰éŒ„æ–‡æœ¬ã€‚è«‹ç›´æ¥è™•ç†è½‰éŒ„æ–‡æœ¬å…§å®¹ï¼Œå¿½ç•¥éˆæ¥éƒ¨åˆ†ã€‚`
            : `## Input Data
${inputText}`;

    switch (mode) {
        case ToolMode.REWRITE:
                return `### ä»»å‹™æŒ‡ä»¤ï¼šæ–‡æœ¬æ”¹å¯«èˆ‡é‡æ§‹

${inputSection}

## åŸæ–‡å­—æ•¸çµ±è¨ˆ
åŸæ–‡å…± ${originalLength} å­—

## Goals
å°ä¸Šè¿°æ–‡æœ¬é€²è¡Œæ·±åº¦æ”¹å¯«ï¼Œä½¿å…¶åœ¨è¡¨é”ä¸Šèˆ‡åŸæ–‡å®Œå…¨ä¸åŒï¼Œä½†æ ¸å¿ƒäº‹å¯¦å’Œè§€é»ä¿æŒä¸€è‡´ã€‚

## Style Context
è«‹ä»¥ ${nicheConfig.name} çš„é¢¨æ ¼å’Œèªæ°£é€²è¡Œæ”¹å¯«ï¼Œèå…¥è©²é ˜åŸŸçš„å°ˆæ¥­è¡“èªå’Œè¡¨é”æ–¹å¼ã€‚

## Constraints & Rules
1. **è©å½™æ›¿æ›**ï¼šä½¿ç”¨åŒç¾©è©æˆ–æ›´é«˜ç´šçš„è©å½™æ›¿æ›åŸæœ‰è©å½™ï¼Œé¿å…é‡è¤‡ã€‚
2. **å¥å¼è®Šæ›**ï¼šå°‡ä¸»å‹•å¥æ”¹ç‚ºè¢«å‹•å¥ï¼Œé•·å¥æ‹†çŸ­ï¼ŒçŸ­å¥åˆä½µï¼Œæ”¹è®Šæ•˜è¿°èªåºã€‚
3. **çµæ§‹èª¿æ•´**ï¼šåœ¨ä¸å½±éŸ¿é‚è¼¯çš„å‰æä¸‹ï¼Œèª¿æ•´æ®µè½æˆ–è«–é»çš„é †åºã€‚
4. **å»AIå‘³**ï¼šé¿å…ä½¿ç”¨æ­»æ¿çš„ç¿»è­¯è…”ï¼Œå¢åŠ å£èªåŒ–æˆ–æ›´è‡ªç„¶çš„é€£æ¥è©ï¼ˆå¦‚"å…¶å¯¦"ã€"æ›å¥è©±èªª"ã€"èªªç™½äº†"ï¼‰ã€‚
5. **å®Œæ•´æ€§**ï¼šçµ•å°ä¸èƒ½ä¸Ÿå¤±åŸæ–‡çš„é—œéµæ•¸æ“šã€å°ˆæœ‰åè©å’Œæ ¸å¿ƒè«–é»ã€‚
6. **è³½é“é¢¨æ ¼èåˆ**ï¼šç¢ºä¿æ”¹å¯«å¾Œçš„æ–‡æœ¬ç¬¦åˆ ${nicheConfig.name} çš„ç¨ç‰¹èªæ°£å’Œè¡¨é”ç¿’æ…£ã€‚
7. **å­—æ•¸ä¿æŒï¼ˆé‡è¦ï¼‰**ï¼šæ”¹å¯«å¾Œçš„æ–‡æœ¬å­—æ•¸å¿…é ˆ >= ${originalLength} å­—ï¼Œä¸å¾—ç¸®æ¸›å…§å®¹ã€‚åŸæ–‡æœ‰5000å­—ï¼Œæ”¹å¯«å¾Œä¹Ÿè¦ä¿æŒ5000å­—å·¦å³çš„ç¯‡å¹…ã€‚
8. **ç¦æ­¢æå‰æ”¶å°¾ï¼ˆé—œéµï¼‰**ï¼š
   - âš ï¸ **ä¸€æ¬¡æ€§è¼¸å‡ºä¸å¯èƒ½å®Œæˆå…¨éƒ¨å…§å®¹ï¼Œç³»çµ±æœƒè‡ªå‹•çºŒå¯«**
   - åœ¨é¦–æ¬¡è¼¸å‡ºæ™‚ï¼Œ**åš´ç¦ä½¿ç”¨ä»»ä½•æ”¶å°¾èª**ï¼ˆå¦‚ã€Œä¸‹èª²ã€ã€Œæ•£æœƒã€ã€Œä¸‹æœŸå†è¦‹ã€ç­‰ï¼‰
   - ä¿æŒå…§å®¹é€£è²«æµæš¢ï¼Œè‡ªç„¶éæ¸¡ï¼Œä¸è¦æœ‰çµæŸçš„æ„æ€
   - åªæœ‰åœ¨å­—æ•¸é”æ¨™å¾Œçš„æœ€çµ‚æ”¶å°¾æ™‚æ‰ä½¿ç”¨æ”¶å°¾èª
9. **TTS ç´”æ·¨è¼¸å‡ºï¼ˆé—œéµï¼‰**ï¼š
   - åš´ç¦è¼¸å‡ºä»»ä½•æ‹¬è™Ÿå…§çš„æè¿°è©ï¼Œå¦‚ã€Œï¼ˆæ•™å®¤çš„ç‡ˆå…‰æ¼¸æ¼¸æš—å»...ï¼‰ã€ã€Œï¼ˆé™¢å¸«çŒ›åœ°ä¸€æ‹é©šå ‚æœ¨...ï¼‰ã€
   - åš´ç¦ä½¿ç”¨ **ã€*ã€__ã€~~ ç­‰ Markdown ç‰¹æ®Šç¬¦è™Ÿ
   - åš´ç¦è¼¸å‡ºç« ç¯€æ¨™è¨˜ã€æ®µè½ç·¨è™Ÿã€èªªæ˜æ–‡å­—ã€æ³¨é‡‹æˆ–å…ƒä¿¡æ¯
   - åªè¼¸å‡ºç´”ç²¹çš„ç¬¬ä¸€äººç¨±èªéŸ³æ–‡ç¨¿å…§å®¹ï¼Œé©åˆç›´æ¥ TTS é…éŸ³

## Output Format
è«‹ç›´æ¥è¼¸å‡ºæ”¹å¯«å¾Œçš„ç´”æ·¨æ–‡æœ¬ï¼Œä¿æŒç°¡æ½”é€£è²«æµæš¢ï¼Œç„¡éœ€è§£é‡‹æˆ–åˆ†æã€‚åš´ç¦ä½¿ç”¨ã€Œ## ã€ã€Œ### ã€ã€Œ1. ã€ã€Œã€ã€‘ã€ã€Œï¼ˆï¼‰ã€ã€Œ**ã€ç­‰ä»»ä½•æ¨™è¨˜ã€‚`;
        case ToolMode.EXPAND:
                const targetMinLength = Math.floor(originalLength * 1.5);
                const targetMaxLength = Math.floor(originalLength * 2);
                return `### ä»»å‹™æŒ‡ä»¤ï¼šæ·±åº¦å…§å®¹æ“´å¯«

${inputSection}

## åŸæ–‡å­—æ•¸çµ±è¨ˆ
åŸæ–‡å…± ${originalLength} å­—
ç›®æ¨™å­—æ•¸ï¼š${targetMinLength}-${targetMaxLength} å­—ï¼ˆ1.5-2å€æ“´å¯«ï¼‰

## Goals
å°‡æä¾›çš„ç°¡çŸ­æ–‡æœ¬æˆ–å¤§ç¶±æ“´å±•ç‚ºä¸€ç¯‡å…§å®¹è©³å¯¦ã€é‚è¼¯åš´å¯†çš„æ·±åº¦æ–‡ç« ï¼Œèå…¥ ${nicheConfig.name} çš„å°ˆæ¥­è¦–è§’ã€‚

## Workflow
1. **åˆ†ææ ¸å¿ƒè§€é»**ï¼šè­˜åˆ¥è¼¸å…¥æ–‡æœ¬ä¸­çš„ä¸»è¦è«–é»å’Œé—œéµè©ã€‚
2. **å¤šç¶­å±•é–‹**ï¼š
   - **Whatï¼ˆæ˜¯ä»€éº¼ï¼‰**ï¼šè©³ç´°è§£é‡‹æ¦‚å¿µå®šç¾©ï¼Œä½¿ç”¨ ${nicheConfig.name} é ˜åŸŸçš„å°ˆæ¥­è¡“èªã€‚
   - **Whyï¼ˆç‚ºä»€éº¼ï¼‰**ï¼šåˆ†æèƒŒå¾Œçš„åŸå› ã€èƒŒæ™¯æˆ–å‹•æ©Ÿï¼Œçµåˆè©²é ˜åŸŸçš„é‚è¼¯å’Œæ€ç¶­æ–¹å¼ã€‚
   - **Howï¼ˆæ€éº¼åšï¼‰**ï¼šæä¾›å…·é«”çš„æ–¹æ³•è«–ã€æ­¥é©Ÿæˆ–è§£æ±ºæ–¹æ¡ˆã€‚
   - **Exampleï¼ˆèˆ‰ä¾‹ï¼‰**ï¼šæ ¹æ“šä¸Šä¸‹æ–‡è™›æ§‹æˆ–å¼•ç”¨ä¸€å€‹è²¼åˆ‡çš„å ´æ™¯/æ¡ˆä¾‹ä¾†ä½è­‰è§€é»ï¼Œæ¡ˆä¾‹è¦ç¬¦åˆè©²é ˜åŸŸç‰¹è‰²ã€‚
3. **è£œå……ç´°ç¯€**ï¼šå¢åŠ å½¢å®¹è©ã€æå¯«æ€§èªå¥å’Œä¿®è¾­æ‰‹æ³•ï¼Œè±å¯Œæ–‡æœ¬çš„é¡†ç²’åº¦ã€‚
4. **é‚è¼¯éŠœæ¥**ï¼šä½¿ç”¨éæ¸¡å¥ï¼Œç¢ºä¿å¾ä¸€å€‹é»åˆ°å¦ä¸€å€‹é»çš„æµå‹•è‡ªç„¶ã€‚
5. **é¢¨æ ¼èåˆ**ï¼šå…¨æ–‡ä¿æŒ ${nicheConfig.name} çš„ç¨ç‰¹èªæ°£å’Œè¡¨é”ç¿’æ…£ã€‚

## Constraints
- æ“´å¯«å¾Œçš„å­—æ•¸å¿…é ˆé”åˆ° ${targetMinLength}-${targetMaxLength} å­—ï¼ˆåŸæ–‡çš„1.5-2å€ï¼‰ã€‚
- ä¿æŒåŸæ–‡çš„èªæ°£ï¼ˆå°ˆæ¥­ã€å¹½é»˜æˆ–åš´è‚…ï¼‰ï¼Œä¸¦èå…¥ ${nicheConfig.name} çš„é¢¨æ ¼ç‰¹è‰²ã€‚
- ä¸è¦å †ç Œç„¡æ„ç¾©çš„å»¢è©±ï¼Œç¢ºä¿æ–°å¢å…§å®¹æœ‰å¯¦è³ªä¿¡æ¯é‡ã€‚
- **ç¦æ­¢æå‰æ”¶å°¾**ï¼šä¸€æ¬¡æ€§è¼¸å‡ºä¸å¯èƒ½å®Œæˆå…¨éƒ¨å…§å®¹ï¼Œé¦–æ¬¡è¼¸å‡ºæ™‚åš´ç¦ä½¿ç”¨ã€Œä¸‹èª²ã€ã€Œæ•£æœƒã€ç­‰æ”¶å°¾èªï¼Œä¿æŒå…§å®¹é€£è²«ã€‚
- **TTS ç´”æ·¨è¼¸å‡º**ï¼šåš´ç¦è¼¸å‡ºæ‹¬è™Ÿå…§çš„æè¿°è©ã€**ã€*ç­‰ç‰¹æ®Šç¬¦è™Ÿã€ç« ç¯€æ¨™è¨˜ã€æ®µè½ç·¨è™Ÿã€èªªæ˜æ–‡å­—æˆ–æ³¨é‡‹ã€‚

## Output Format
ç›´æ¥è¼¸å‡ºæ“´å¯«å¾Œçš„å®Œæ•´ç´”æ·¨æ–‡ç« ï¼Œä¿æŒç°¡æ½”é€£è²«æµæš¢ï¼Œç„¡éœ€åˆ†æ®µæ¨™è¨˜æˆ–å…ƒä¿¡æ¯ã€‚åš´ç¦ä½¿ç”¨ã€Œ## ã€ã€Œ### ã€ã€Œç¬¬ä¸€ç« ã€ã€Œï¼ˆï¼‰ã€ã€Œ**ã€ç­‰æ¨™è¨˜ã€‚`;
        case ToolMode.SUMMARIZE:
                return `### ä»»å‹™æŒ‡ä»¤ï¼šYouTube å…§å®¹æ‘˜è¦èˆ‡å„ªåŒ–

${inputSection}

## Goals
å¾ ${nicheConfig.name} é ˜åŸŸå°ˆå®¶çš„è¦–è§’ï¼Œç‚ºä¸Šè¿°æ–‡æœ¬ç”Ÿæˆå®Œæ•´çš„ YouTube è¦–é »å…§å®¹åŒ…è£æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æ¨™é¡Œã€ç°¡ä»‹ã€æ¨™ç±¤å’Œå°é¢è¨­è¨ˆæ–¹æ¡ˆã€‚

## Output Requirementsï¼ˆå¿…é ˆç¹é«”ä¸­æ–‡è¼¸å‡ºï¼‰

è«‹æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¼¸å‡ºï¼š

æ ¸å¿ƒä¸»é¡Œï¼š
ç”¨ä¸€å¥è©±æ¦‚æ‹¬é€™ç¯‡æ–‡ç« åœ¨è¬›ä»€éº¼ï¼Œè¦ç²¾æº–ä¸”å¸å¼•äººã€‚

YouTube çˆ†æ¬¾æ¨™é¡Œï¼ˆ5å€‹ï¼‰ï¼š
1. [æ¨™é¡Œ1 - èå…¥ ${nicheConfig.name} çš„å°ˆæ¥­è¡“èªï¼Œ40-60å­—]
2. [æ¨™é¡Œ2 - ä½¿ç”¨æ•¸å­—æˆ–ç–‘å•å¥å¢å¼·å¸å¼•åŠ›]
3. [æ¨™é¡Œ3 - å¸¶æœ‰æƒ…ç·’å¼µåŠ›æˆ–æ‡¸å¿µæ„Ÿ]
4. [æ¨™é¡Œ4 - çµåˆç†±é»æˆ–çˆ­è­°æ€§è©±é¡Œ]
5. [æ¨™é¡Œ5 - ç›´æ“Šç—›é»æˆ–æä¾›è§£æ±ºæ–¹æ¡ˆ]

è¦–é »ç°¡ä»‹ï¼š
[é–‹å ´é‰¤å­1-2å¥è©±]

æ ¸å¿ƒè¦é»ï¼š
â€¢ [è¦é»1]
â€¢ [è¦é»2]
â€¢ [è¦é»3]
â€¢ [è¦é»4]
â€¢ [è¦é»5]

[çµå°¾CTA - å‘¼ç±²è¨‚é–±/è©•è«–/åˆ†äº«]

ç†±é–€æ¨™ç±¤ï¼š
#æ¨™ç±¤1 #æ¨™ç±¤2 #æ¨™ç±¤3 #æ¨™ç±¤4 #æ¨™ç±¤5 #æ¨™ç±¤6 #æ¨™ç±¤7 #æ¨™ç±¤8 #æ¨™ç±¤9 #æ¨™ç±¤10

ã€æ¨™ç±¤èªè¨€è¦å‰‡ã€‘
- âš ï¸ æ¨™ç±¤èªè¨€å¿…é ˆèˆ‡æ–‡æ¡ˆå…§å®¹èªè¨€ä¸€è‡´
- å¦‚æœæ–‡æ¡ˆæ˜¯ç¹é«”ä¸­æ–‡ï¼Œæ¨™ç±¤å¿…é ˆå…¨éƒ¨ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼ˆå¦‚ #å€ªæµ·å»ˆ #ä¸­é†«ç„å­¸ #é¢¨æ°´ï¼‰
- å¦‚æœæ–‡æ¡ˆæ˜¯ç°¡é«”ä¸­æ–‡ï¼Œæ¨™ç±¤å¿…é ˆå…¨éƒ¨ä½¿ç”¨ç°¡é«”ä¸­æ–‡
- å¦‚æœæ–‡æ¡ˆæ˜¯è‹±æ–‡ï¼Œæ¨™ç±¤æ‰ä½¿ç”¨è‹±æ–‡
- åŒ…å« ${nicheConfig.name} é ˜åŸŸå°ˆå±¬æ¨™ç±¤å’Œé€šç”¨ç†±é–€æ¨™ç±¤
- ç¦æ­¢ä¸­è‹±æ–‡æ··åˆæ¨™ç±¤

å°é¢è¨­è¨ˆæ–¹æ¡ˆï¼š

AI åœ–ç‰‡æç¤ºè©ï¼ˆ5å€‹ï¼‰ï¼š
1. [æç¤ºè©1 - æè¿°å°é¢è¦–è¦ºå…ƒç´ ï¼Œé©åˆ Midjourney/Stable Diffusionï¼Œè‹±æ–‡æˆ–ä¸­æ–‡]
2. [æç¤ºè©2 - å¼·èª¿æ ¸å¿ƒæ¦‚å¿µå’Œæƒ…ç·’å¼µåŠ›]
3. [æç¤ºè©3 - çªå‡ºé—œéµäººç‰©æˆ–å ´æ™¯]
4. [æç¤ºè©4 - å±•ç¾è¡çªæˆ–å°æ¯”]
5. [æç¤ºè©5 - ç‡Ÿé€ æ‡¸å¿µæˆ–ç¥ç§˜æ„Ÿ]

å°é¢æ¨™é¡Œæ–‡æ¡ˆï¼ˆ5å€‹ï¼Œæ¯å€‹åˆ†ä¸Šä¸­ä¸‹ä¸‰è¡Œï¼‰ï¼š
1. 
   ä¸Šè¡Œï¼š[æ ¸å¿ƒæ¦‚å¿µï¼Œä¸è¶…é10å­—]
   ä¸­è¡Œï¼š[é—œéµä¿¡æ¯ï¼Œä¸è¶…é10å­—]
   ä¸‹è¡Œï¼š[è¡Œå‹•å‘¼ç±²æˆ–æ‡¸å¿µï¼Œä¸è¶…é10å­—]

2. 
   ä¸Šè¡Œï¼š[æ ¸å¿ƒæ¦‚å¿µï¼Œä¸è¶…é10å­—]
   ä¸­è¡Œï¼š[é—œéµä¿¡æ¯ï¼Œä¸è¶…é10å­—]
   ä¸‹è¡Œï¼š[è¡Œå‹•å‘¼ç±²æˆ–æ‡¸å¿µï¼Œä¸è¶…é10å­—]

3. 
   ä¸Šè¡Œï¼š[æ ¸å¿ƒæ¦‚å¿µï¼Œä¸è¶…é10å­—]
   ä¸­è¡Œï¼š[é—œéµä¿¡æ¯ï¼Œä¸è¶…é10å­—]
   ä¸‹è¡Œï¼š[è¡Œå‹•å‘¼ç±²æˆ–æ‡¸å¿µï¼Œä¸è¶…é10å­—]

4. 
   ä¸Šè¡Œï¼š[æ ¸å¿ƒæ¦‚å¿µï¼Œä¸è¶…é10å­—]
   ä¸­è¡Œï¼š[é—œéµä¿¡æ¯ï¼Œä¸è¶…é10å­—]
   ä¸‹è¡Œï¼š[è¡Œå‹•å‘¼ç±²æˆ–æ‡¸å¿µï¼Œä¸è¶…é10å­—]

5. 
   ä¸Šè¡Œï¼š[æ ¸å¿ƒæ¦‚å¿µï¼Œä¸è¶…é10å­—]
   ä¸­è¡Œï¼š[é—œéµä¿¡æ¯ï¼Œä¸è¶…é10å­—]
   ä¸‹è¡Œï¼š[è¡Œå‹•å‘¼ç±²æˆ–æ‡¸å¿µï¼Œä¸è¶…é10å­—]

ã€å°é¢è¨­è¨ˆè¦æ±‚ã€‘
- åœ–ç‰‡æç¤ºè©è¦å…·é«”æè¿°è¦–è¦ºå…ƒç´ ã€è‰²å½©ã€æ§‹åœ–ã€é¢¨æ ¼
- å°é¢æ¨™é¡Œæ–‡æ¡ˆå¿…é ˆå¾å…§å®¹æ ¸å¿ƒæç…‰ï¼Œæ¯è¡Œä¸è¶…é10å€‹å­—
- æ¨™é¡Œæ–‡æ¡ˆè¦ç°¡æ½”æœ‰åŠ›ï¼Œå…·æœ‰è¦–è¦ºè¡æ“ŠåŠ›
- ä¸Šä¸­ä¸‹ä¸‰è¡Œè¦æœ‰é‚è¼¯å±¤æ¬¡ï¼šä¸Šè¡Œå¸å¼•æ³¨æ„ï¼Œä¸­è¡Œå‚³é”æ ¸å¿ƒï¼Œä¸‹è¡Œå¼•ç™¼è¡Œå‹•

## Output Format
è«‹åš´æ ¼æŒ‰ç…§ä¸Šè¿°æ ¼å¼è¼¸å‡ºï¼Œä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œç„¡éœ€é¡å¤–è§£é‡‹æˆ–åˆ†æã€‚åš´ç¦ä½¿ç”¨ **ã€*ã€__ã€~~ ç­‰ Markdown ç‰¹æ®Šç¬¦è™Ÿã€‚`;
        case ToolMode.POLISH:
                return `### ä»»å‹™æŒ‡ä»¤ï¼šæ–‡æœ¬æ½¤è‰²èˆ‡å„ªåŒ–

${inputSection}

## åŸæ–‡å­—æ•¸çµ±è¨ˆ
åŸæ–‡å…± ${originalLength} å­—

## Goals
åƒä¸€ä½åš´å²çš„æ–‡å­—ç·¨è¼¯ä¸€æ¨£ï¼Œä»¥ ${nicheConfig.name} é ˜åŸŸçš„å°ˆæ¥­æ¨™æº–å„ªåŒ–é€™æ®µæ–‡æœ¬ï¼Œä½¿å…¶æ›´å…·å°ˆæ¥­æ„Ÿã€æµæš¢æ„Ÿå’Œé«˜ç´šæ„Ÿã€‚

## Checkpoints
1. **èªæ³•ä¿®æ­£**ï¼šç³¾æ­£æ‰€æœ‰éŒ¯åˆ¥å­—ã€æ¨™é»éŒ¯èª¤å’Œèªç—…ã€‚
2. **è©å½™å‡ç´š**ï¼šå°‡å¹³åº¸çš„è©å½™æ›¿æ›ç‚ºæ›´ç²¾æº–ã€æ›´å…·è¡¨ç¾åŠ›çš„è©å½™ï¼ˆä¾‹å¦‚å°‡"å¾ˆå¤š"æ”¹ç‚º"ä¸å‹æšèˆ‰"ï¼Œå°‡"å¥½"æ”¹ç‚º"å“è¶Š"ï¼‰ï¼Œä¸¦èå…¥ ${nicheConfig.name} é ˜åŸŸçš„å°ˆæ¥­è¡“èªã€‚
3. **ä¿®è¾­å¢å¼·**ï¼šåœ¨åˆé©çš„åœ°æ–¹åŠ å…¥æ’æ¯”ã€æ¯”å–»ã€åå•ç­‰ä¿®è¾­æ‰‹æ³•ï¼Œå¢å¼·æ„ŸæŸ“åŠ›å’ŒèªªæœåŠ›ã€‚
4. **ç²¾ç°¡å†—é¤˜**ï¼šåˆªé™¤å›‰å—¦çš„é‡è¤‡è¡¨é”ï¼Œä½¿å¥å­æ›´ä¹¾ç·´æœ‰åŠ›ã€‚
5. **èªæ°£çµ±ä¸€**ï¼šç¢ºä¿å…¨æ–‡èªæ°£ä¸€è‡´ï¼ˆæ ¹æ“šåŸæ–‡åˆ¤æ–·æ˜¯å•†å‹™é¢¨ã€å­¸è¡“é¢¨é‚„æ˜¯æ–‡å­¸é¢¨ï¼‰ï¼Œä¸¦å¼·åŒ– ${nicheConfig.name} çš„ç¨ç‰¹é¢¨æ ¼ã€‚
6. **é‚è¼¯æµæš¢**ï¼šå„ªåŒ–å¥å­ä¹‹é–“çš„éŠœæ¥ï¼Œç¢ºä¿æ€è·¯é€£è²«ã€å±¤æ¬¡åˆ†æ˜ã€‚
7. **å­—æ•¸ä¿æŒ**ï¼šæ½¤è‰²å¾Œçš„å­—æ•¸æ‡‰èˆ‡åŸæ–‡ç›¸ç•¶ï¼ˆç´„ ${originalLength} å­—ï¼‰ï¼Œä¸è¦å¤§å¹…ç¸®æ¸›æˆ–æ“´å……ã€‚
8. **ç¦æ­¢æå‰æ”¶å°¾**ï¼šé¦–æ¬¡è¼¸å‡ºæ™‚åš´ç¦ä½¿ç”¨ã€Œä¸‹èª²ã€ã€Œæ•£æœƒã€ç­‰æ”¶å°¾èªï¼Œä¿æŒå…§å®¹é€£è²«æµæš¢ã€‚
9. **TTS ç´”æ·¨è¼¸å‡ºï¼ˆé—œéµï¼‰**ï¼šåš´ç¦è¼¸å‡ºæ‹¬è™Ÿå…§çš„æè¿°è©ã€**ã€*ç­‰ç‰¹æ®Šç¬¦è™Ÿï¼Œåªè¼¸å‡ºç´”ç²¹çš„ç¬¬ä¸€äººç¨±èªéŸ³æ–‡ç¨¿ã€‚

## Comparison Standard
åœ¨"ä¿¡ï¼ˆæº–ç¢ºï¼‰ã€é”ï¼ˆé€šé †ï¼‰ã€é›…ï¼ˆå„ªç¾ï¼‰"ä¸‰å€‹ç¶­åº¦ä¸Šéƒ½å¿…é ˆæœ‰æ˜é¡¯æå‡ï¼ŒåŒæ™‚ä¿æŒ ${nicheConfig.name} çš„å°ˆæ¥­é¢¨ç¯„ã€‚

## Output Format
è«‹ç›´æ¥è¼¸å‡ºæ½¤è‰²å¾Œçš„ç´”æ·¨æœ€çµ‚ç‰ˆæœ¬ï¼Œä¿æŒç°¡æ½”é€£è²«æµæš¢ï¼Œç„¡éœ€æ¨™è¨»ä¿®æ”¹ç—•è·¡æˆ–è§£é‡‹ã€‚åš´ç¦ä½¿ç”¨ã€Œ## ã€ã€Œ### ã€ã€Œä¿®æ”¹èªªæ˜ï¼šã€ã€Œï¼ˆï¼‰ã€ã€Œ**ã€ç­‰ä»»ä½•æ¨™è¨˜ã€‚`;
        case ToolMode.SCRIPT:
                // æ£€æµ‹è¯­è¨€ï¼ˆç®€å•åˆ¤æ–­ï¼šå¦‚æœåŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œè®¤ä¸ºæ˜¯ä¸­æ–‡ï¼‰
                const isChinese = /[\u4e00-\u9fff]/.test(inputText);
                const minChars = isChinese ? 150 : 450;
                const maxChars = isChinese ? 250 : 800;
                
                return `### ä»»åŠ¡æŒ‡ä»¤ï¼šè§†é¢‘è„šæœ¬ç”Ÿæˆ

${inputSection}

## åŸæ–‡å­—æ•°ç»Ÿè®¡
åŸæ–‡å…± ${originalLength} å­—

## Goals
å°†ä¸Šè¿°æ–‡æœ¬å†…å®¹è½¬æ¢ä¸ºé€‚åˆè¯­éŸ³è§†é¢‘åˆ¶ä½œçš„è„šæœ¬æ¨¡æ¿ï¼ŒåŒ…å«é•œå¤´åˆ†é•œã€å›¾ç‰‡æç¤ºè¯ã€è§†é¢‘æç¤ºè¯ã€è¯­éŸ³åˆ†é•œå’ŒéŸ³æ•ˆè®¾è®¡ã€‚

## è¾“å‡ºè¦æ±‚ï¼ˆCRITICALï¼‰

### é•œå¤´æ•°é‡é™åˆ¶
- é•œå¤´æ€»æ•°ä¸å¾—è¶…è¿‡ 60 ä¸ª
- æ ¹æ®åŸæ–‡é•¿åº¦å’Œå†…å®¹å¯†åº¦åˆç†åˆ†é…é•œå¤´æ•°é‡
- æ¯ä¸ªé•œå¤´å¯¹åº”ä¸€æ®µè¿ç»­çš„æ–‡æœ¬å†…å®¹

### é•œå¤´æ ¼å¼ï¼ˆæ¯ä¸ªé•œå¤´å¿…é¡»åŒ…å«ä»¥ä¸‹æ‰€æœ‰å­—æ®µï¼‰

é•œå¤´[åºå·]
é•œå¤´æ–‡æ¡ˆ: [è§’è‰²å]-[è¯­æ°”è¯]ï¼š"[è¿™é‡Œå¡«å…¥åŸæ–‡çš„è¿ç»­é•¿æ®µè½ï¼Œ${isChinese ? 'ä¸­æ–‡' : 'è‹±æ–‡'}ï¼ˆ${minChars}-${maxChars}å­—ï¼‰ï¼Œæ— åŠ¨ä½œæè¿°ï¼Œçº¯å‡€æ–‡æœ¬]"
å›¾ç‰‡æç¤ºè¯: [æ™¯åˆ«], [ç”»é¢æè¿°], [ç¯å¢ƒæè¿°]
è§†é¢‘æç¤ºè¯: [ç§’æ•°]s: [ç”»é¢æè¿°], [è¿é•œæ–¹å¼]
æ™¯åˆ«: [å…¨æ™¯/ä¸­æ™¯/ç‰¹å†™]
è¯­éŸ³åˆ†é•œ: [è§’è‰²å]
éŸ³æ•ˆ: [å…·ä½“çš„éŸ³æ•ˆå]

### è§’è‰²ä¿¡æ¯ï¼ˆåœ¨æ‰€æœ‰é•œå¤´è¾“å‡ºå®Œæ¯•åè¾“å‡ºï¼‰
âš ï¸ **å…³é”®è¦æ±‚**ï¼šåªæœ‰åœ¨æ‰€æœ‰é•œå¤´éƒ½è¾“å‡ºå®Œæˆåï¼Œæ‰èƒ½è¾“å‡ºè§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯ã€‚ä¸¥ç¦åœ¨é•œå¤´æœªå®Œæˆæ—¶è¾“å‡ºè§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯ã€‚

æ ¹æ®å†…å®¹åˆ†æï¼Œæå–æ‰€æœ‰å‡ºç°çš„è§’è‰²ï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

[è§’è‰²ä¿¡æ¯]
[åç§°]åŒ»ç”Ÿ
[åˆ«å]å€ªåŒ»ç”Ÿï¼Œä¸»æ’­
[æè¿°]ä¸€ä½55å²ä¸­å¹´ç”·æ€§ï¼Œèº«é«˜175cmï¼Œä¸€å¤´æ•´é½çš„é»‘ç™½ç›¸é—´çŸ­å‘ï¼Œèº«æé€‚ä¸­ï¼Œç©¿ç€ä¸€èº«æ·±ç°è‰²çš„ä¼ ç»Ÿé•¿è¡«ï¼ˆæˆ–ä¸­å±±è£…ï¼‰ï¼Œé¢å®¹æ¸…ç™¯ï¼Œçœ¼ç¥æ·±é‚ƒä¸”åšå®šï¼Œæœ‰ä¸€ç§çœ‹é€ä¸–äº‹çš„æ™ºæ…§æ„Ÿã€‚

[åç§°]... (å…¶ä»–è§’è‰²)

âš ï¸ **æ ¼å¼è¦æ±‚ï¼ˆCRITICALï¼‰**ï¼š
1. ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ ¼å¼ï¼Œæ¯ä¸ªå­—æ®µå‰å¿…é¡»æœ‰[åç§°]ã€[åˆ«å]ã€[æè¿°]æ ‡è®°
2. ä¸è¦æ·»åŠ ä»»ä½•é¢å¤–çš„è¯´æ˜ã€æ ‡é¢˜ã€è§£é‡Šæˆ–æ³¨é‡Š
3. ä¸è¦è¾“å‡º"é•œå¤´"ã€"è„šæœ¬"ã€"å·²å®Œæˆ"ç­‰ä»»ä½•æ¨¡æ¿ä¹‹å‰çš„ä¿¡æ¯
4. æ¯ä¸ªè§’è‰²ä¹‹é—´ç”¨ç©ºè¡Œåˆ†éš”
5. åªè¾“å‡ºè§’è‰²ä¿¡æ¯ï¼Œæ ¼å¼å¿…é¡»å®Œå…¨ä¸€è‡´

### åœºæ™¯ä¿¡æ¯ï¼ˆåœ¨è§’è‰²ä¿¡æ¯ä¹‹åè¾“å‡ºï¼‰
æ ¹æ®å†…å®¹åˆ†æï¼Œæå–æ‰€æœ‰å‡ºç°çš„åœºæ™¯ï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

[åœºæ™¯ä¿¡æ¯]
[åç§°]åœºæ™¯-å®¤å†…
[åˆ«å]æ— 
[æè¿°]å¤è‰²å¤é¦™çš„ä¹¦æˆ¿æˆ–è¯Šå®¤ï¼ŒèƒŒæ™¯æœ‰ä¹¦æ¶ã€åŒ»å­¦ç»ç»œå›¾ã€æ¯›ç¬”å­—ç”»ï¼Œå…‰çº¿æŸ”å’Œåº„é‡ã€‚

[åç§°]... (å…¶ä»–åœºæ™¯)

âš ï¸ **æ ¼å¼è¦æ±‚ï¼ˆCRITICALï¼‰**ï¼š
1. ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ ¼å¼ï¼Œæ¯ä¸ªå­—æ®µå‰å¿…é¡»æœ‰[åç§°]ã€[åˆ«å]ã€[æè¿°]æ ‡è®°
2. ä¸è¦æ·»åŠ ä»»ä½•é¢å¤–çš„è¯´æ˜ã€æ ‡é¢˜ã€è§£é‡Šæˆ–æ³¨é‡Š
3. ä¸è¦é‡å¤è¾“å‡ºè§’è‰²ä¿¡æ¯æˆ–é•œå¤´ä¿¡æ¯
4. æ¯ä¸ªåœºæ™¯ä¹‹é—´ç”¨ç©ºè¡Œåˆ†éš”
5. åªè¾“å‡ºåœºæ™¯ä¿¡æ¯ï¼Œæ ¼å¼å¿…é¡»å®Œå…¨ä¸€è‡´

## è¯¦ç»†è¦æ±‚

### é•œå¤´æ–‡æ¡ˆ
- å¿…é¡»æ˜¯åŸæ–‡çš„è¿ç»­é•¿æ®µè½ï¼Œä¸è¦æ‹†åˆ†è¿‡ç»†
- ${isChinese ? 'ä¸­æ–‡' : 'è‹±æ–‡'}å†…å®¹ï¼šæ¯ä¸ªé•œå¤´ ${minChars}-${maxChars} å­—
- æ— åŠ¨ä½œæè¿°ï¼Œçº¯å‡€æ–‡æœ¬ï¼Œé€‚åˆ TTS è¯­éŸ³åˆæˆ
- æ ¼å¼ï¼š[è§’è‰²å]-[è¯­æ°”è¯]ï¼š"[æ–‡æœ¬å†…å®¹]"
- è¯­æ°”è¯é™å®šï¼šåªèƒ½ä½¿ç”¨ä»¥ä¸‹å…­ç§ä¹‹ä¸€ï¼šé«˜å…´ã€æ„¤æ€’ã€æ‚²ä¼¤ã€å®³æ€•ã€æƒŠè®¶ã€å¹³é™

### å›¾ç‰‡æç¤ºè¯
- å¿…é¡»é€‚åˆ AI ç»˜å›¾å·¥å…·ï¼ˆMidjourney/Stable Diffusion/DALL-Eï¼‰
- åŒ…å«ï¼šæ™¯åˆ«ï¼ˆå…¨æ™¯/ä¸­æ™¯/ç‰¹å†™ï¼‰ã€ç”»é¢æè¿°ã€ç¯å¢ƒæè¿°
- æè¿°è¦å…·ä½“ã€è§†è§‰åŒ–ï¼ŒåŒ…å«è‰²å½©ã€æ„å›¾ã€å…‰çº¿ç­‰å…ƒç´ 
- æ ¹æ® ${nicheConfig.name} é¢†åŸŸç‰¹è‰²è®¾è®¡è§†è§‰é£æ ¼

### è§†é¢‘æç¤ºè¯
- æ ¼å¼ï¼š[ç§’æ•°]s: [ç”»é¢æè¿°], [è¿é•œæ–¹å¼]
- ç§’æ•°ï¼šæ ¹æ®æ–‡æ¡ˆé•¿åº¦åˆç†åˆ†é…ï¼ˆé€šå¸¸ 5-15 ç§’ï¼‰
- è¿é•œæ–¹å¼ï¼šæ¨æ‹‰æ‘‡ç§»ã€å›ºå®šæœºä½ã€è·Ÿéšã€ç¯ç»•ç­‰
- ç”»é¢æè¿°ï¼šç®€æ´æè¿°è¯¥æ—¶æ®µçš„è§†è§‰é‡ç‚¹

### æ™¯åˆ«
- å¿…é¡»æ˜¯ï¼šå…¨æ™¯ã€ä¸­æ™¯ã€ç‰¹å†™ ä¸‰è€…ä¹‹ä¸€
- æ ¹æ®å†…å®¹é‡ç‚¹é€‰æ‹©åˆé€‚çš„æ™¯åˆ«

### è¯­éŸ³åˆ†é•œ
- æ ‡æ³¨è¯¥é•œå¤´çš„ä¸»è¦è¯´è¯è§’è‰²
- å¦‚æœæ²¡æœ‰æ˜ç¡®è§’è‰²ï¼Œä½¿ç”¨"æ—ç™½"æˆ–"è§£è¯´"

### éŸ³æ•ˆ
- å…·ä½“çš„éŸ³æ•ˆåç§°ï¼Œå¦‚ï¼šèƒŒæ™¯éŸ³ä¹ã€é”®ç›˜æ•²å‡»å£°ã€è„šæ­¥å£°ã€ç¯å¢ƒéŸ³ç­‰
- å¦‚æœä¸éœ€è¦éŸ³æ•ˆï¼Œæ ‡æ³¨"æ— "æˆ–"èƒŒæ™¯éŸ³ä¹"

## è¾“å‡ºæ ¼å¼ç¤ºä¾‹

é•œå¤´1
é•œå¤´æ–‡æ¡ˆ: åŒ»ç”Ÿ-å¹³é™ï¼š"[150-250å­—çš„ä¸­æ–‡æ–‡æœ¬æˆ–450-800å­—çš„è‹±æ–‡æ–‡æœ¬]"
å›¾ç‰‡æç¤ºè¯: ä¸­æ™¯, ä¸€ä½ä¸­å¹´ç”·æ€§åŒ»ç”Ÿååœ¨å¤è‰²å¤é¦™çš„ä¹¦æˆ¿ä¸­, èƒŒæ™¯æœ‰ä¹¦æ¶å’ŒåŒ»å­¦å›¾è°±, æŸ”å’Œçš„å…‰çº¿
è§†é¢‘æç¤ºè¯: 8s: åŒ»ç”Ÿå¹³é™è®²è¿°, å›ºå®šæœºä½
æ™¯åˆ«: ä¸­æ™¯
è¯­éŸ³åˆ†é•œ: åŒ»ç”Ÿ
éŸ³æ•ˆ: èƒŒæ™¯éŸ³ä¹

é•œå¤´2
...

[è§’è‰²ä¿¡æ¯]
[åç§°]åŒ»ç”Ÿ
[åˆ«å]å€ªåŒ»ç”Ÿï¼Œä¸»æ’­
[æè¿°]ä¸€ä½55å²ä¸­å¹´ç”·æ€§ï¼Œèº«é«˜175cmï¼Œä¸€å¤´æ•´é½çš„é»‘ç™½ç›¸é—´çŸ­å‘ï¼Œèº«æé€‚ä¸­ï¼Œç©¿ç€ä¸€èº«æ·±ç°è‰²çš„ä¼ ç»Ÿé•¿è¡«ï¼ˆæˆ–ä¸­å±±è£…ï¼‰ï¼Œé¢å®¹æ¸…ç™¯ï¼Œçœ¼ç¥æ·±é‚ƒä¸”åšå®šï¼Œæœ‰ä¸€ç§çœ‹é€ä¸–äº‹çš„æ™ºæ…§æ„Ÿã€‚

[åœºæ™¯ä¿¡æ¯]
[åç§°]åœºæ™¯-å®¤å†…
[åˆ«å]æ— 
[æè¿°]å¤è‰²å¤é¦™çš„ä¹¦æˆ¿æˆ–è¯Šå®¤ï¼ŒèƒŒæ™¯æœ‰ä¹¦æ¶ã€åŒ»å­¦ç»ç»œå›¾ã€æ¯›ç¬”å­—ç”»ï¼Œå…‰çº¿æŸ”å’Œåº„é‡ã€‚

## Output Format
è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ ¼å¼è¾“å‡ºï¼Œä½¿ç”¨ç®€ä½“ä¸­æ–‡ï¼ˆè§’è‰²å’Œåœºæ™¯æè¿°éƒ¨åˆ†ï¼‰ï¼Œé•œå¤´æ–‡æ¡ˆä¿æŒåŸæ–‡è¯­è¨€ã€‚ä¸¥ç¦ä½¿ç”¨ **ã€*ã€__ã€~~ ç­‰ Markdown ç‰¹æ®Šç¬¦å·ã€‚

## ç»­å†™è§„åˆ™
- å¦‚æœä¸€æ¬¡æ€§æ— æ³•å®Œæˆå…¨éƒ¨è„šæœ¬ï¼Œåœ¨æœ€åä¸€ä¸ªå®Œæ•´é•œå¤´åè¾“å‡ºã€Œ------ã€ï¼ˆ6ä¸ªæ¨ªçº¿ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç»­å†™
- ç»­å†™æ—¶ä»ã€Œ------ã€ä¸‹ä¸€è¡Œå¼€å§‹ï¼Œç»§ç»­è¾“å‡ºä¸‹ä¸€ä¸ªé•œå¤´
- å¿…é¡»å®Œæˆæ‰€æœ‰é•œå¤´ã€è§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯æ‰ç®—å®Œæ•´

## è§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯è¾“å‡ºè¦æ±‚ï¼ˆCRITICALï¼‰
- æ‰€æœ‰é•œå¤´è¾“å‡ºå®Œæ¯•åï¼Œæ¥ç€è¾“å‡ºè§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯
- ä¸¥æ ¼æŒ‰ç…§æ ¼å¼è¾“å‡ºï¼Œä¸è¦å¢åŠ æˆ–å‡å°‘ä»»ä½•ä¿¡æ¯
- ä¸è¦è¾“å‡ºä»»ä½•æ¨¡æ¿ä¹‹å‰çš„ä¿¡æ¯ï¼ˆå¦‚"é•œå¤´"ã€"è„šæœ¬"ç­‰ï¼‰
- ä¸è¦æ·»åŠ ä»»ä½•è¯´æ˜ã€æ ‡é¢˜æˆ–è§£é‡Š
- åªè¾“å‡ºè§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯ï¼Œæ ¼å¼å¿…é¡»å®Œå…¨ä¸€è‡´`;
            default:
                return '';
        }
    };

    // ç”Ÿæˆç»­å†™prompt
    const generateContinuePrompt = (currentContent: string, mode: ToolMode, originalLength: number, cleanInfo?: { cleaned: string; lastShotNumber: number; needsRework: boolean } | null): string => {
        const context = currentContent.slice(-2000); // å–æœ€å2000å­—ä½œä¸ºä¸Šä¸‹æ–‡ï¼ˆè„šæœ¬æ¨¡å¼éœ€è¦æ›´å¤šä¸Šä¸‹æ–‡ï¼‰
        const currentLength = currentContent.length;
        
        if (mode === ToolMode.REWRITE || mode === ToolMode.POLISH) {
            const progress = (currentLength / originalLength * 100).toFixed(0);
            const needsMore = currentLength < originalLength * 0.9;
            
            return `ç¹¼çºŒå®Œæˆä¸Šè¿° ${nicheConfig.name} é¢¨æ ¼çš„${mode === ToolMode.REWRITE ? 'æ”¹å¯«' : 'æ½¤è‰²'}ï¼Œä¿æŒé¢¨æ ¼ä¸€è‡´ã€‚

ã€å·²å®Œæˆéƒ¨åˆ†ï¼ˆæœ«å°¾ï¼‰ã€‘
${context}

ã€å­—æ•¸çµ±è¨ˆã€‘
- åŸæ–‡ï¼š${originalLength} å­—
- å·²å®Œæˆï¼š${currentLength} å­—ï¼ˆ${progress}%ï¼‰
- ${needsMore ? `âš ï¸ é‚„éœ€è¦ç´„ ${originalLength - currentLength} å­—` : 'âœ“ æ¥è¿‘ç›®æ¨™'}

ã€çºŒå¯«è¦å‰‡ï¼ˆé‡è¦ï¼‰ã€‘
${needsMore ? 
`âš ï¸ **å­—æ•¸åš´é‡ä¸è¶³ï¼Œåš´ç¦ä½¿ç”¨ä»»ä½•æ”¶å°¾èªï¼**
- åš´ç¦ä½¿ç”¨ã€Œä¸‹èª²ã€ã€Œæ•£æœƒã€ã€Œä¸‹æœŸå†è¦‹ã€ã€Œä»Šå¤©å°±åˆ°é€™ã€ç­‰æ”¶å°¾è©
- ç›´æ¥è‡ªç„¶éŠœæ¥ä¸Šæ–‡ï¼Œç¹¼çºŒ${mode === ToolMode.REWRITE ? 'æ”¹å¯«' : 'æ½¤è‰²'}
- ä¿æŒå…§å®¹æµæš¢é€£è²«ï¼Œä¸è¦æœ‰çµæŸçš„æ„æ€` :
`âœ“ å­—æ•¸å·²æ¥è¿‘ç›®æ¨™ï¼Œå¯ä»¥é©ç•¶æ”¶å°¾
- åœ¨å…§å®¹è‡ªç„¶çµæŸæ™‚ï¼Œå¯ä»¥ä½¿ç”¨ã€Œä¸‹èª²ã€ã€Œä¸‹æœŸå†è¦‹ã€ç­‰æ”¶å°¾èª
- æ·»åŠ äº’å‹•å¼•å°ï¼ˆå¦‚ã€Œæ­¡è¿åœ¨è©•è«–å€åˆ†äº«ä½ çš„çœ‹æ³•ã€ï¼‰`}
- **TTS ç´”æ·¨è¼¸å‡º**ï¼šåš´ç¦è¼¸å‡ºæ‹¬è™Ÿå…§çš„æè¿°è©ã€**ã€*ç­‰ç‰¹æ®Šç¬¦è™Ÿ
- ç¬¬ä¸€è¡Œå¿…é ˆæ˜¯ã€Œ-----ã€ï¼Œç¬¬äºŒè¡Œé–‹å§‹ç›´æ¥çºŒå¯«`;
        } else if (mode === ToolMode.EXPAND) {
            const targetMin = Math.floor(originalLength * 1.5);
            const progress = (currentLength / targetMin * 100).toFixed(0);
            const needsMore = currentLength < originalLength * 1.4;
            
            return `ç¹¼çºŒå®Œæˆä¸Šè¿° ${nicheConfig.name} é¢¨æ ¼çš„æ·±åº¦æ“´å¯«ï¼Œä¿æŒé¢¨æ ¼ä¸€è‡´ã€‚

ã€å·²å®Œæˆéƒ¨åˆ†ï¼ˆæœ«å°¾ï¼‰ã€‘
${context}

ã€å­—æ•¸çµ±è¨ˆã€‘
- åŸæ–‡ï¼š${originalLength} å­—ï¼Œç›®æ¨™ï¼š${targetMin} å­—
- å·²æ“´å¯«ï¼š${currentLength} å­—ï¼ˆ${progress}%ï¼‰
- ${needsMore ? `âš ï¸ é‚„éœ€è¦ç´„ ${targetMin - currentLength} å­—` : 'âœ“ æ¥è¿‘ç›®æ¨™'}

ã€çºŒå¯«è¦å‰‡ï¼ˆé‡è¦ï¼‰ã€‘
${needsMore ?
`âš ï¸ **å­—æ•¸åš´é‡ä¸è¶³ï¼Œåš´ç¦ä½¿ç”¨ä»»ä½•æ”¶å°¾èªï¼**
- ç›´æ¥è‡ªç„¶éŠœæ¥ä¸Šæ–‡ï¼Œç¹¼çºŒæ·±å…¥å±•é–‹è«–è¿°
- ä¿æŒå…§å®¹æµæš¢ï¼Œä¸è¦æœ‰çµæŸçš„æ„æ€` :
`âœ“ å­—æ•¸å·²æ¥è¿‘ç›®æ¨™ï¼Œå¯ä»¥é©ç•¶æ”¶å°¾
- ç¢ºä¿å…§å®¹å®Œæ•´ã€é‚è¼¯é–‰ç’°
- å¯ä»¥ä½¿ç”¨é©ç•¶çš„æ”¶å°¾èªå’Œäº’å‹•å¼•å°`}
- **TTS ç´”æ·¨è¼¸å‡º**ï¼šåš´ç¦è¼¸å‡ºæ‹¬è™Ÿå…§çš„æè¿°è©ã€**ã€*ç­‰ç‰¹æ®Šç¬¦è™Ÿ
- ç¬¬ä¸€è¡Œå¿…é ˆæ˜¯ã€Œ-----ã€ï¼Œç¬¬äºŒè¡Œé–‹å§‹ç›´æ¥çºŒå¯«`;
        } else if (mode === ToolMode.SCRIPT) {
            // æ£€æµ‹è¯­è¨€
            const isChinese = /[\u4e00-\u9fff]/.test(inputText);
            const minChars = isChinese ? 150 : 450;
            const maxChars = isChinese ? 250 : 800;
            
            // ç»Ÿè®¡å·²å®Œæˆçš„é•œå¤´æ•°é‡
            const shotCount = (currentContent.match(/é¡é ­\d+|é•œå¤´\d+/g) || []).length;
            const hasRoleInfo = currentContent.includes('[è§’è‰²ä¿¡æ¯]') || currentContent.includes('[è§’è‰²ä¿¡æ¯]');
            const hasSceneInfo = currentContent.includes('[å ´æ™¯ä¿¡æ¯]') || currentContent.includes('[åœºæ™¯ä¿¡æ¯]');
            
            // ä¼°ç®—è¿˜éœ€è¦å¤šå°‘é•œå¤´ï¼ˆåŸºäºåŸæ–‡é•¿åº¦å’Œå·²å®Œæˆå†…å®¹ï¼‰
            const estimatedTotalShots = Math.min(60, Math.ceil(originalLength / (isChinese ? 200 : 600)));
            const remainingShots = Math.max(0, estimatedTotalShots - shotCount);
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°è¾“å‡ºä¸å®Œæ•´çš„é•œå¤´
            const needsRework = cleanInfo?.needsRework || false;
            const lastShotNumber = cleanInfo?.lastShotNumber || shotCount;
            
            let reworkInstruction = '';
            if (needsRework) {
                reworkInstruction = `\n\nã€é‡è¦ï¼šé‡æ–°è¾“å‡ºä¸å®Œæ•´é•œå¤´ã€‘
æ£€æµ‹åˆ°é•œå¤´${lastShotNumber}è¾“å‡ºä¸å®Œæ•´ï¼ˆç¼ºå°‘å¿…éœ€å­—æ®µæˆ–å­—æ®µæœªå®Œæˆï¼‰ã€‚
è¯·ä»ã€Œ------ã€ä¸‹ä¸€è¡Œå¼€å§‹ï¼Œé‡æ–°å®Œæ•´è¾“å‡ºé•œå¤´${lastShotNumber}ï¼ŒåŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µï¼š
- é•œå¤´${lastShotNumber}
- é•œå¤´æ–‡æ¡ˆ: [è§’è‰²å]-[è¯­æ°”è¯]ï¼š"[å®Œæ•´æ–‡æœ¬]"
- å›¾ç‰‡æç¤ºè¯: [æ™¯åˆ«], [ç”»é¢æè¿°], [ç¯å¢ƒæè¿°]
- è§†é¢‘æç¤ºè¯: [ç§’æ•°]s: [ç”»é¢æè¿°], [è¿é•œæ–¹å¼]
- æ™¯åˆ«: [å…¨æ™¯/ä¸­æ™¯/ç‰¹å†™]
- è¯­éŸ³åˆ†é•œ: [è§’è‰²å]
- éŸ³æ•ˆ: [å…·ä½“çš„éŸ³æ•ˆå]

è¾“å‡ºå®Œé•œå¤´${lastShotNumber}åï¼Œå¦‚æœè¿˜æœ‰å‰©ä½™é•œå¤´ï¼Œç»§ç»­è¾“å‡ºä¸‹ä¸€ä¸ªé•œå¤´ã€‚`;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é•œå¤´éƒ½å·²å®Œæˆï¼ˆå¿…é¡»è¾¾åˆ°æˆ–è¶…è¿‡é¢„è®¡æ•°é‡ï¼Œä¸”æœ€åä¸€ä¸ªé•œå¤´å®Œæ•´ï¼‰
            const allShotsComplete = shotCount >= estimatedTotalShots && !cleanInfo?.needsRework;
            
            let roleSceneInstruction = '';
            // åªæœ‰åœ¨æ‰€æœ‰é•œå¤´éƒ½å®Œæˆåï¼Œæ‰è¾“å‡ºè§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯
            if (allShotsComplete && !hasRoleInfo && !hasSceneInfo) {
                roleSceneInstruction = `\n\nã€è¾“å‡ºè§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯ - æ‰€æœ‰é•œå¤´å·²å®Œæˆã€‘
âš ï¸ é‡è¦ï¼šæ‰€æœ‰é•œå¤´ï¼ˆ${shotCount}ä¸ªï¼‰å·²è¾“å‡ºå®Œæˆï¼Œç°åœ¨å¿…é¡»è¾“å‡ºè§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯ã€‚

ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œä¸è¦å¢åŠ æˆ–å‡å°‘ä»»ä½•ä¿¡æ¯ï¼Œä¹Ÿä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ï¼š

[è§’è‰²ä¿¡æ¯]
[åç§°]åŒ»ç”Ÿ
[åˆ«å]å€ªåŒ»ç”Ÿï¼Œä¸»æ’­
[æè¿°]ä¸€ä½55å²ä¸­å¹´ç”·æ€§ï¼Œèº«é«˜175cmï¼Œä¸€å¤´æ•´é½çš„é»‘ç™½ç›¸é—´çŸ­å‘ï¼Œèº«æé€‚ä¸­ï¼Œç©¿ç€ä¸€èº«æ·±ç°è‰²çš„ä¼ ç»Ÿé•¿è¡«ï¼ˆæˆ–ä¸­å±±è£…ï¼‰ï¼Œé¢å®¹æ¸…ç™¯ï¼Œçœ¼ç¥æ·±é‚ƒä¸”åšå®šï¼Œæœ‰ä¸€ç§çœ‹é€ä¸–äº‹çš„æ™ºæ…§æ„Ÿã€‚

[åç§°]... (å…¶ä»–è§’è‰²)

[åœºæ™¯ä¿¡æ¯]
[åç§°]åœºæ™¯-å®¤å†…
[åˆ«å]æ— 
[æè¿°]å¤è‰²å¤é¦™çš„ä¹¦æˆ¿æˆ–è¯Šå®¤ï¼ŒèƒŒæ™¯æœ‰ä¹¦æ¶ã€åŒ»å­¦ç»ç»œå›¾ã€æ¯›ç¬”å­—ç”»ï¼Œå…‰çº¿æŸ”å’Œåº„é‡ã€‚

[åç§°]... (å…¶ä»–åœºæ™¯)

âš ï¸ æ ¼å¼è¦æ±‚ï¼ˆCRITICALï¼‰ï¼š
1. ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ ¼å¼ï¼Œæ¯ä¸ªå­—æ®µå‰å¿…é¡»æœ‰[åç§°]ã€[åˆ«å]ã€[æè¿°]æ ‡è®°
2. ä¸è¦æ·»åŠ ä»»ä½•é¢å¤–çš„è¯´æ˜ã€æ ‡é¢˜ã€è§£é‡Šæˆ–æ³¨é‡Š
3. ä¸è¦è¾“å‡º"é•œå¤´"ã€"è„šæœ¬"ã€"å·²å®Œæˆ"ç­‰ä»»ä½•æ¨¡æ¿ä¹‹å‰çš„ä¿¡æ¯
4. è§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯ä¹‹é—´ç”¨ç©ºè¡Œåˆ†éš”
5. æ¯ä¸ªè§’è‰²æˆ–åœºæ™¯ä¹‹é—´ç”¨ç©ºè¡Œåˆ†éš”
6. åªè¾“å‡ºè§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯ï¼Œæ ¼å¼å¿…é¡»å®Œå…¨ä¸€è‡´`;
            } else if (allShotsComplete && hasRoleInfo && !hasSceneInfo) {
                roleSceneInstruction = `\n\nã€è¾“å‡ºåœºæ™¯ä¿¡æ¯ - æ‰€æœ‰é•œå¤´å·²å®Œæˆã€‘
è§’è‰²ä¿¡æ¯å·²å®Œæˆï¼Œç°åœ¨éœ€è¦è¾“å‡ºåœºæ™¯ä¿¡æ¯ã€‚

ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œä¸è¦å¢åŠ æˆ–å‡å°‘ä»»ä½•ä¿¡æ¯ï¼š

[åœºæ™¯ä¿¡æ¯]
[åç§°]åœºæ™¯-å®¤å†…
[åˆ«å]æ— 
[æè¿°]å¤è‰²å¤é¦™çš„ä¹¦æˆ¿æˆ–è¯Šå®¤ï¼ŒèƒŒæ™¯æœ‰ä¹¦æ¶ã€åŒ»å­¦ç»ç»œå›¾ã€æ¯›ç¬”å­—ç”»ï¼Œå…‰çº¿æŸ”å’Œåº„é‡ã€‚

[åç§°]... (å…¶ä»–åœºæ™¯)

âš ï¸ æ³¨æ„ï¼šåªè¾“å‡ºåœºæ™¯ä¿¡æ¯ï¼Œä¸¥æ ¼æŒ‰ç…§æ ¼å¼ï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ã€‚`;
            } else if (allShotsComplete && !hasRoleInfo && hasSceneInfo) {
                roleSceneInstruction = `\n\nã€è¾“å‡ºè§’è‰²ä¿¡æ¯ - æ‰€æœ‰é•œå¤´å·²å®Œæˆã€‘
åœºæ™¯ä¿¡æ¯å·²å®Œæˆï¼Œç°åœ¨éœ€è¦è¾“å‡ºè§’è‰²ä¿¡æ¯ã€‚

ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œä¸è¦å¢åŠ æˆ–å‡å°‘ä»»ä½•ä¿¡æ¯ï¼š

[è§’è‰²ä¿¡æ¯]
[åç§°]åŒ»ç”Ÿ
[åˆ«å]å€ªåŒ»ç”Ÿï¼Œä¸»æ’­
[æè¿°]ä¸€ä½55å²ä¸­å¹´ç”·æ€§ï¼Œèº«é«˜175cmï¼Œä¸€å¤´æ•´é½çš„é»‘ç™½ç›¸é—´çŸ­å‘ï¼Œèº«æé€‚ä¸­ï¼Œç©¿ç€ä¸€èº«æ·±ç°è‰²çš„ä¼ ç»Ÿé•¿è¡«ï¼ˆæˆ–ä¸­å±±è£…ï¼‰ï¼Œé¢å®¹æ¸…ç™¯ï¼Œçœ¼ç¥æ·±é‚ƒä¸”åšå®šï¼Œæœ‰ä¸€ç§çœ‹é€ä¸–äº‹çš„æ™ºæ…§æ„Ÿã€‚

[åç§°]... (å…¶ä»–è§’è‰²)

âš ï¸ æ³¨æ„ï¼šåªè¾“å‡ºè§’è‰²ä¿¡æ¯ï¼Œä¸¥æ ¼æŒ‰ç…§æ ¼å¼ï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ã€‚`;
            }
            
            return `ç»§ç»­å®Œæˆè§†é¢‘è„šæœ¬ç”Ÿæˆï¼Œä¿æŒæ ¼å¼ä¸€è‡´ã€‚

ã€å·²å®Œæˆéƒ¨åˆ†ï¼ˆæœ«å°¾ï¼‰ã€‘
${context}

ã€è¿›åº¦ç»Ÿè®¡ã€‘
- åŸæ–‡ï¼š${originalLength} å­—
- å·²å®Œæˆé•œå¤´ï¼š${shotCount} ä¸ª
- é¢„è®¡æ€»é•œå¤´ï¼šçº¦ ${estimatedTotalShots} ä¸ªï¼ˆä¸è¶…è¿‡60ä¸ªï¼‰
- è¿˜éœ€å®Œæˆï¼šçº¦ ${remainingShots} ä¸ªé•œå¤´
- è§’è‰²ä¿¡æ¯ï¼š${hasRoleInfo ? 'âœ“ å·²å®Œæˆ' : 'âœ— æœªå®Œæˆ'}
- åœºæ™¯ä¿¡æ¯ï¼š${hasSceneInfo ? 'âœ“ å·²å®Œæˆ' : 'âœ— æœªå®Œæˆ'}${reworkInstruction}${roleSceneInstruction}

ã€ç»­å†™è¦æ±‚ï¼ˆCRITICALï¼‰ã€‘${!needsRework && !roleSceneInstruction ? `
1. **ç»§ç»­è¾“å‡ºé•œå¤´**ï¼šä»ã€Œ------ã€ä¸‹ä¸€è¡Œå¼€å§‹ï¼Œç»§ç»­è¾“å‡ºä¸‹ä¸€ä¸ªé•œå¤´
2. **é•œå¤´æ ¼å¼**ï¼šå¿…é¡»åŒ…å«æ‰€æœ‰å­—æ®µï¼ˆé•œå¤´åºå·ã€é•œå¤´æ–‡æ¡ˆã€å›¾ç‰‡æç¤ºè¯ã€è§†é¢‘æç¤ºè¯ã€æ™¯åˆ«ã€è¯­éŸ³åˆ†é•œã€éŸ³æ•ˆï¼‰
3. **é•œå¤´æ–‡æ¡ˆ**ï¼š
   - ${isChinese ? 'ä¸­æ–‡' : 'è‹±æ–‡'}å†…å®¹ï¼šæ¯ä¸ªé•œå¤´ ${minChars}-${maxChars} å­—
   - æ ¼å¼ï¼š[è§’è‰²å]-[è¯­æ°”è¯]ï¼š"[æ–‡æœ¬å†…å®¹]"
   - è¯­æ°”è¯é™å®šï¼šåªèƒ½ä½¿ç”¨ä»¥ä¸‹å…­ç§ä¹‹ä¸€ï¼šé«˜å…´ã€æ„¤æ€’ã€æ‚²ä¼¤ã€å®³æ€•ã€æƒŠè®¶ã€å¹³é™
   - å¿…é¡»æ˜¯åŸæ–‡çš„è¿ç»­é•¿æ®µè½ï¼Œæ— åŠ¨ä½œæè¿°ï¼Œçº¯å‡€æ–‡æœ¬
4. **å›¾ç‰‡æç¤ºè¯**ï¼šé€‚åˆ AI ç»˜å›¾å·¥å…·ï¼ŒåŒ…å«æ™¯åˆ«ã€ç”»é¢æè¿°ã€ç¯å¢ƒæè¿°
5. **è§†é¢‘æç¤ºè¯**ï¼šæ ¼å¼ [ç§’æ•°]s: [ç”»é¢æè¿°], [è¿é•œæ–¹å¼]
6. **æ™¯åˆ«**ï¼šå¿…é¡»æ˜¯ å…¨æ™¯ã€ä¸­æ™¯ã€ç‰¹å†™ ä¸‰è€…ä¹‹ä¸€
7. **å®Œæˆæ ‡è®°**ï¼š
   - å¦‚æœæœ¬æ¬¡è¾“å‡ºæ— æ³•å®Œæˆå…¨éƒ¨é•œå¤´ï¼Œåœ¨æœ€åä¸€ä¸ªå®Œæ•´é•œå¤´åè¾“å‡ºã€Œ------ã€ï¼ˆ6ä¸ªæ¨ªçº¿ï¼‰
   - âš ï¸ **ä¸¥ç¦æå‰è¾“å‡ºè§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯**ï¼šåªæœ‰åœ¨æ‰€æœ‰é•œå¤´ï¼ˆ${estimatedTotalShots}ä¸ªï¼‰éƒ½è¾“å‡ºå®Œæˆåï¼Œæ‰èƒ½è¾“å‡ºè§’è‰²ä¿¡æ¯å’Œåœºæ™¯ä¿¡æ¯
   - å¦‚æœæ‰€æœ‰å†…å®¹éƒ½å·²å®Œæˆï¼Œä¸éœ€è¦è¾“å‡ºã€Œ------ã€` : ''}

ã€è¾“å‡ºæ ¼å¼ã€‘
ç¬¬ä¸€è¡Œå¿…é¡»æ˜¯ã€Œ------ã€ï¼Œç¬¬äºŒè¡Œå¼€å§‹ç›´æ¥è¾“å‡ºã€‚

è¯·ä½¿ç”¨ç®€ä½“ä¸­æ–‡è¾“å‡ºï¼ˆè§’è‰²å’Œåœºæ™¯æè¿°éƒ¨åˆ†ï¼‰ï¼Œé•œå¤´æ–‡æ¡ˆä¿æŒåŸæ–‡è¯­è¨€ã€‚ä¸¥ç¦ä½¿ç”¨ **ã€*ã€__ã€~~ ç­‰ Markdown ç‰¹æ®Šç¬¦å·ã€‚`;
        }
        
        return '';
    };

    try {
        initializeGemini(apiKey, { provider });
        
        // ç”Ÿæˆåˆå§‹å†…å®¹
        const initialPrompt = generateInitialPrompt(mode, originalLength);
        await streamContentGeneration(initialPrompt, systemInstruction, (chunk) => {
            localOutput += chunk;
            setOutputText(cleanMarkdownFormat(localOutput, mode));
        });
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦ç»­å†™ï¼ˆæ‘˜è¦æ¨¡å¼ä¸éœ€è¦ç»­å†™ï¼‰
        if (mode !== ToolMode.SUMMARIZE) {
            while (!isContentComplete(localOutput, mode, originalLength) && continuationCount < MAX_CONTINUATIONS) {
                continuationCount++;
                console.log(`[Tools] Content incomplete, continuing (${continuationCount}/${MAX_CONTINUATIONS})...`);
                
                // è„šæœ¬æ¨¡å¼ï¼šæ£€æµ‹å¹¶æ¸…ç†ä¸å®Œæ•´çš„é•œå¤´
                let cleanInfo: { cleaned: string; lastShotNumber: number; needsRework: boolean } | null = null;
                if (mode === ToolMode.SCRIPT) {
                    cleanInfo = cleanIncompleteShot(localOutput);
                    if (cleanInfo.needsRework) {
                        console.log(`[Tools] Detected incomplete shot ${cleanInfo.lastShotNumber}, cleaning and reworking...`);
                        localOutput = cleanInfo.cleaned;
                        setOutputText(cleanMarkdownFormat(localOutput, mode));
                    }
                }
                
                // æ·»åŠ åˆ†éš”ç¬¦ï¼ˆè„šæœ¬æ¨¡å¼ä½¿ç”¨------ï¼Œå…¶ä»–æ¨¡å¼ä½¿ç”¨-----ï¼‰
                const separator = mode === ToolMode.SCRIPT ? '\n\n------\n\n' : '\n\n-----\n\n';
                localOutput += separator;
                setOutputText(cleanMarkdownFormat(localOutput, mode));
                
                // ç”Ÿæˆç»­å†™promptï¼ˆä¼ å…¥æ¸…ç†åçš„å†…å®¹å’Œæ˜¯å¦éœ€è¦é‡æ–°è¾“å‡ºé•œå¤´çš„ä¿¡æ¯ï¼‰
                const continuePrompt = generateContinuePrompt(localOutput, mode, originalLength, cleanInfo);
                
                // ç»­å†™
                await streamContentGeneration(continuePrompt, systemInstruction, (chunk) => {
                    localOutput += chunk;
                    setOutputText(cleanMarkdownFormat(localOutput, mode));
                });
            }
            
            // æ¸…ç†ç»­å†™åˆ†éš”ç¬¦ï¼ˆè„šæœ¬æ¨¡å¼ä½¿ç”¨------ï¼Œå…¶ä»–æ¨¡å¼ä½¿ç”¨-----ï¼‰
            if (mode === ToolMode.SCRIPT) {
                localOutput = localOutput.replace(/\n*------\n*/g, '\n\n');
            } else {
                localOutput = localOutput.replace(/\n*-----\n*/g, '\n\n');
            }
            // æ¸…ç†å¤šä½™ç©ºè¡Œ
            localOutput = localOutput.replace(/\n\s*\n\s*\n+/g, '\n\n').trim();
            setOutputText(cleanMarkdownFormat(localOutput, mode));
            
            if (isContentComplete(localOutput, mode, originalLength)) {
                console.log('[Tools] Content generation complete');
            } else {
                console.log('[Tools] Reached max continuations, stopping');
            }
        }
    } catch (e: any) {
        const errorMsg = e?.message || String(e) || 'æœªçŸ¥éŒ¯èª¤';
        console.error('[Tools] Error:', e);
        
        // å¦‚æœæ˜¯ YouTube é“¾æ¥ä¸”é”™è¯¯ä¿¡æ¯æç¤ºéœ€è¦è½¬å½•æ–‡æœ¬ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º
        if (isYouTube && (errorMsg.includes('ç¶²çµ¡') || errorMsg.includes('API Key') || errorMsg.includes('é€£æ¥'))) {
            setOutputText(`âš ï¸ YouTube è¦–é »è™•ç†æç¤º\n\næª¢æ¸¬åˆ°æ‚¨è¼¸å…¥çš„æ˜¯ YouTube è¦–é »éˆæ¥ã€‚\n\nç”±æ–¼ç³»çµ±ç„¡æ³•ç›´æ¥è¨ªå• YouTube è¦–é »å…§å®¹ï¼Œè«‹æŒ‰ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼š\n\n1. æ‰“é–‹ YouTube è¦–é »\n2. é»æ“Šã€Œâ‹¯ã€èœå–® â†’ é¸æ“‡ã€Œé¡¯ç¤ºè½‰éŒ„ã€æˆ–ã€Œå­—å¹•ã€\n3. è¤‡è£½å®Œæ•´çš„è½‰éŒ„æ–‡æœ¬\n4. å°‡è½‰éŒ„æ–‡æœ¬ç²˜è²¼åˆ°æ­¤è™•ï¼ˆå¯ä»¥ä¿ç•™æˆ–åˆªé™¤ YouTube éˆæ¥ï¼‰\n5. å†æ¬¡é»æ“Šç”ŸæˆæŒ‰éˆ•\n\næˆ–è€…ï¼Œå¦‚æœæ‚¨å·²ç¶“æœ‰è½‰éŒ„æ–‡æœ¬ï¼Œè«‹å°‡æ–‡æœ¬å’Œéˆæ¥ä¸€èµ·ç²˜è²¼ï¼Œç³»çµ±æœƒè‡ªå‹•è™•ç†æ–‡æœ¬å…§å®¹ã€‚\n\n---\n\néŒ¯èª¤è©³æƒ…ï¼š${errorMsg}`);
        } else {
            // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            setOutputText(`âŒ ç”Ÿæˆå…§å®¹æ™‚ç™¼ç”ŸéŒ¯èª¤\n\néŒ¯èª¤ä¿¡æ¯ï¼š${errorMsg}\n\nè«‹æª¢æŸ¥ï¼š\n1. API Key æ˜¯å¦æ­£ç¢ºé…ç½®\n2. ç¶²çµ¡é€£æ¥æ˜¯å¦æ­£å¸¸\n3. API æœå‹™æ˜¯å¦å¯ç”¨\n\nå¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹è¯ç¹«æŠ€è¡“æ”¯æŒã€‚`);
        }
    } finally {
        setIsGenerating(false);
    }
  };

  const copyToClipboard = () => {
    navigator.clipboard.writeText(outputText);
  };

  return (
    <div className="max-w-5xl mx-auto space-y-6">
       {/* Settings Bar */}
       <div className="flex flex-col md:flex-row gap-4 justify-between items-center bg-slate-800/50 p-4 rounded-xl border border-slate-800">
           <div className="flex gap-2 overflow-x-auto pb-2 md:pb-0 w-full md:w-auto">
                {/* Tool Modes */}
                {[
                    { id: ToolMode.REWRITE, label: 'æ”¹å¯«/æ´—ç¨¿', icon: <RefreshCw size={16} /> },
                    { id: ToolMode.EXPAND, label: 'æ·±åº¦æ“´å¯«', icon: <Maximize2 size={16} /> },
                    { id: ToolMode.SUMMARIZE, label: 'æ‘˜è¦ç¸½çµ', icon: <Scissors size={16} /> },
                    { id: ToolMode.POLISH, label: 'æ½¤è‰²å„ªåŒ–', icon: <FileText size={16} /> },
                    { id: ToolMode.SCRIPT, label: 'è…³æœ¬è¼¸å‡º', icon: <Video size={16} /> },
                ].map((tool) => (
                    <button
                        key={tool.id}
                        onClick={() => setMode(tool.id as ToolMode)}
                        className={`px-4 py-2 rounded-lg border flex items-center gap-2 transition-all whitespace-nowrap text-sm font-medium ${
                            mode === tool.id 
                            ? 'bg-indigo-600 text-white border-indigo-500 shadow-md' 
                            : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'
                        }`}
                    >
                        {tool.icon}
                        <span>{tool.label}</span>
                    </button>
                ))}
           </div>

           <div className="flex items-center gap-4 w-full md:w-auto">
           {/* Niche Context Selector */}
               <div className="relative group min-w-[200px] flex-1 md:flex-none">
               <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 ml-1 tracking-wider">èªæ°£ / è³½é“</label>
               <select 
                    value={niche} 
                    onChange={(e) => setNiche(e.target.value as NicheType)}
                    className="w-full appearance-none bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:outline-none focus:border-indigo-500 cursor-pointer"
               >
                   {Object.values(NICHES).map(n => (
                       <option key={n.id} value={n.id}>{n.icon} {n.name}</option>
                   ))}
               </select>
               <ChevronDown className="absolute right-3 top-8 text-slate-500 pointer-events-none" size={14} />
               </div>

               {/* Generate Button */}
               <button 
                   onClick={handleAction}
                   disabled={isGenerating || !inputText}
                   className="flex items-center gap-2 px-4 md:px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white font-medium rounded-lg shadow-lg shadow-indigo-900/20 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:scale-105 active:scale-95 whitespace-nowrap"
               >
                   <ArrowRight size={18} />
                   <span className="hidden sm:inline">ç”Ÿæˆ</span>
               </button>
           </div>
       </div>

      {/* Grid: Input and Output */}
       <div className="grid grid-cols-1 md:grid-cols-2 gap-6 h-[600px]">
            {/* Input */}
            <div className="flex flex-col gap-2">
          <label className="text-sm font-medium text-slate-400 flex items-center gap-2">
            <span>åŸå§‹æ–‡æœ¬</span>
            <span className="text-xs text-slate-600">ï¼ˆæ”¯æŒ YouTube éˆæ¥è‡ªå‹•æå–ï¼‰</span>
          </label>
                <textarea 
                    value={inputText}
                    onChange={(e) => setInputText(e.target.value)}
            placeholder="è«‹åœ¨æ­¤ç²˜è²¼æ‚¨çš„å…§å®¹æˆ– YouTube éˆæ¥..."
                    className="flex-1 bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-slate-200 resize-none focus:outline-none focus:ring-1 focus:ring-indigo-500 leading-relaxed custom-scrollbar"
                />
            </div>

            {/* Output */}
            <div className="flex flex-col gap-2 relative">
                <label className="text-sm font-medium text-slate-400 flex justify-between items-center">
                    <span>ç”Ÿæˆçµæœ</span>
                    {outputText && (
                        <button onClick={copyToClipboard} className="text-xs flex items-center gap-1 text-indigo-400 hover:text-indigo-300">
                            <Copy size={12} /> è¤‡è£½
                        </button>
                    )}
                </label>
                <div className="flex-1 bg-slate-950 border border-slate-800 rounded-xl p-4 text-slate-200 overflow-y-auto whitespace-pre-wrap leading-relaxed relative custom-scrollbar">
                    {outputText}
                    {isGenerating && (
                        <>
                            {!outputText && (
                                <div className="absolute inset-0 flex items-center justify-center text-slate-400 text-sm">
                                    <div className="flex items-center gap-2">
                                        <span className="inline-block w-2 h-4 bg-indigo-500 animate-pulse" />
                                        <span>ç”Ÿæˆä¸­...</span>
                                    </div>
                                </div>
                            )}
                            {outputText && <span className="inline-block w-2 h-4 bg-indigo-500 ml-1 animate-pulse" />}
                        </>
                    )}
                    {!outputText && !isGenerating && (
                        <div className="absolute inset-0 flex items-center justify-center text-slate-600 text-sm">
                            çµæœå°‡é¡¯ç¤ºæ–¼æ­¤
                </div>
                    )}
                </div>
            </div>
       </div>
    </div>
  );
};