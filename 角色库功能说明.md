# 🎭 角色库功能说明

## 📋 功能概述

角色库功能允许您上传和管理角色图片，当图片提示词中包含角色库中的名字时，系统会自动使用角色图片进行图生图（Image-to-Image）生成。

## ✨ 主要特性

1. **角色管理**：上传、编辑、删除角色
2. **别名支持**：为角色设置多个别名，提高匹配准确度
3. **自动检测**：自动检测提示词中的角色名字
4. **自动图生图**：检测到角色时，自动使用角色图片进行图生图生成
5. **本地存储**：角色数据保存在浏览器本地存储中

## 🎯 支持的模型

目前**仅即梦（Jimeng）模型支持图生图功能**。

其他模型（DALL·E 3、Sora Image、Banana、Flux、Grok等）暂不支持图生图，即使检测到角色，也会使用文生图模式。

## 📖 使用指南

### 1. 打开角色库管理

1. 在媒体生成页面，选择**即梦（Jimeng）**模型
2. 在即梦API配置区域，点击**"管理"**按钮（角色库）
3. 角色库管理窗口将打开

### 2. 添加角色

1. 点击**"添加角色"**按钮
2. 输入角色名字（必填）
3. 输入别名（可选，用逗号分隔多个别名）
4. 点击**"选择图片"**上传角色图片
5. 点击**"保存"**完成添加

**示例**：
- 角色名字：`小明`
- 别名：`小明明, 明哥, 小明同学`
- 图片：上传一张小明的照片

### 3. 编辑角色

1. 在角色列表中，找到要编辑的角色
2. 点击**"编辑"**按钮
3. 修改名字、别名或图片
4. 点击**"保存"**完成更新

### 4. 删除角色

1. 在角色列表中，找到要删除的角色
2. 点击**"删除"**按钮
3. 确认删除操作

### 5. 使用角色进行图生图

1. 确保已添加角色到角色库
2. 在图片提示词中包含角色的名字或别名
3. 选择**即梦（Jimeng）**模型
4. 点击**"生成图片"**

**系统会自动**：
- 检测提示词中的角色名字
- 如果检测到角色，显示提示信息
- 使用角色图片进行图生图生成

**示例提示词**：
- `小明在公园里玩耍` → 检测到"小明"，使用小明的角色图片进行图生图
- `小明明在教室里学习` → 检测到"小明明"（别名），使用小明的角色图片进行图生图

## 🔍 检测逻辑

系统会检测提示词中是否包含：
1. **角色主名字**：完全匹配（不区分大小写）
2. **角色别名**：完全匹配（不区分大小写）

**匹配规则**：
- 使用 `includes()` 方法进行子串匹配
- 不区分大小写
- 如果提示词中包含多个角色，使用第一个匹配的角色图片

**示例**：
- 提示词：`小明和小红在公园里`
- 角色库：`小明`、`小红`
- 结果：使用`小明`的图片（第一个匹配的角色）

## ⚙️ 技术细节

### 图生图参数

当检测到角色时，系统会使用以下默认参数：
- **采样强度（sample_strength）**：`0.7`（可调整范围：0.0-1.0）
- **图片**：使用第一个匹配角色的图片URL

### 存储方式

- 角色数据保存在 `localStorage` 中
- 存储键名：`CHARACTER_LIBRARY`
- 图片以 base64 格式存储

### 图片格式支持

- **支持格式**：JPEG、JPG、PNG、WebP、GIF
- **最大大小**：10MB
- **存储格式**：base64 data URL

## 🚨 注意事项

1. **仅即梦模型支持**：其他模型不支持图生图，即使检测到角色也会使用文生图模式
2. **图片大小限制**：单个图片最大10MB，建议使用较小的图片以节省存储空间
3. **存储空间**：角色数据保存在浏览器本地存储中，如果存储空间不足，可能无法保存
4. **匹配准确性**：系统使用简单的字符串匹配，可能误匹配（例如："小明"会匹配"小明同学"）
5. **多个角色**：如果提示词中包含多个角色，只使用第一个匹配的角色图片

## 🔧 故障排查

### 问题1：检测不到角色

**可能原因**：
- 角色名字拼写错误
- 提示词中没有包含角色名字
- 角色名字在别名中，但别名设置不正确

**解决方案**：
- 检查角色名字和别名是否正确
- 确保提示词中包含角色名字或别名
- 检查大小写（虽然不区分大小写，但建议保持一致）

### 问题2：图生图失败

**可能原因**：
- 即梦API服务未启动
- SESSION_ID无效
- 图片格式不支持
- 网络连接问题

**解决方案**：
- 检查即梦API服务是否运行（http://localhost:3030）
- 检查SESSION_ID是否正确
- 检查图片格式是否支持
- 检查网络连接

### 问题3：角色图片无法显示

**可能原因**：
- 图片数据损坏
- 存储空间不足
- 浏览器缓存问题

**解决方案**：
- 重新上传角色图片
- 清理浏览器缓存
- 检查浏览器存储空间

## 📝 更新日志

### v1.0.0 (2026-01-20)
- ✅ 初始版本发布
- ✅ 支持角色管理（增删改查）
- ✅ 支持别名设置
- ✅ 支持自动检测提示词中的角色
- ✅ 支持自动图生图（仅即梦模型）
- ✅ 支持本地存储

## 🎉 开始使用

1. 打开媒体生成页面
2. 选择即梦模型
3. 点击"管理"按钮打开角色库
4. 添加您的第一个角色
5. 在提示词中使用角色名字
6. 享受自动图生图的便利！

---

**最后更新**：2026-01-20  
**版本**：1.0.0
