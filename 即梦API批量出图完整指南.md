# 🎨 即梦API批量出图完整指南

## 📋 目录

1. [系统架构说明](#系统架构说明)
2. [环境准备](#环境准备)
3. [获取SESSION_ID](#获取session_id)
4. [启动即梦API服务](#启动即梦api服务)
5. [启动前端网站](#启动前端网站)
6. [配置即梦API](#配置即梦api)
7. [批量出图操作](#批量出图操作)
8. [常见问题排查](#常见问题排查)

---

## 🏗️ 系统架构说明

### 服务架构图

```
┌─────────────────┐
│   前端网站      │  http://localhost:3000
│  (React + Vite) │
└────────┬────────┘
         │ HTTP请求
         │ (包含 SESSION_ID)
         ▼
┌─────────────────┐
│  即梦API服务    │  http://localhost:3030
│  (Node.js)      │
└────────┬────────┘
         │ 调用即梦官方API
         │ (使用 SESSION_ID)
         ▼
┌─────────────────┐
│  即梦官方API    │  https://api.jimeng.ai
│  (即梦服务器)   │
└─────────────────┘
```

### 端口说明

- **3000端口**: 前端网站（用户界面）
- **3030端口**: 即梦API服务（后端代理服务）

### 数据流向

1. **用户在前端输入提示词** → 选择即梦模型 → 点击生成
2. **前端调用** `jimengService.ts` → 发送请求到 `http://localhost:3030`
3. **即梦API服务** 接收请求 → 使用 `SESSION_ID` 调用即梦官方API
4. **即梦官方API** 生成图片 → 返回图片URL
5. **前端显示** 生成的图片

---

## 🔧 环境准备

### 必需软件

1. **Node.js** (版本 16+)
   - 下载地址: https://nodejs.org/
   - 验证安装: 打开命令行，输入 `node -v`

2. **npm** (通常随 Node.js 一起安装)
   - 验证安装: 打开命令行，输入 `npm -v`

3. **Python 3** (可选，用于某些脚本)
   - 下载地址: https://www.python.org/

### 项目依赖

项目已包含所有必要的依赖，首次运行时会自动安装。

---

## 🔑 获取SESSION_ID

### 方法一：从浏览器Cookie获取（推荐）

1. **打开即梦官网**
   - 访问: https://www.jimeng.ai
   - 登录您的账号

2. **打开浏览器开发者工具**
   - 按 `F12` 或右键页面 → 选择"检查"
   - 切换到 **"Application"** 标签（Chrome）或 **"存储"** 标签（Firefox）

3. **查找SESSION_ID**
   - 在左侧找到 **"Cookies"** → 展开 `https://www.jimeng.ai`
   - 查找名为 `SESSION_ID` 或 `sessionid` 的Cookie
   - 复制其 **Value** 值

4. **示例**
   ```
   Cookie名称: SESSION_ID
   Cookie值: 6eac93ccd72cf4372558f38ee2a3161a
   ```

### 方法二：从网络请求获取

1. **打开浏览器开发者工具**
   - 按 `F12` 打开开发者工具
   - 切换到 **"Network"**（网络）标签

2. **访问即梦网站并操作**
   - 在即梦网站上进行任何操作（如生成图片）
   - 在Network标签中找到任意API请求

3. **查看请求头**
   - 点击请求 → 查看 **"Headers"** 标签
   - 在 **"Request Headers"** 中找到 `Cookie` 字段
   - 从Cookie字符串中提取 `SESSION_ID` 的值

### ⚠️ 重要提示

- **SESSION_ID 是敏感信息**，请妥善保管，不要泄露
- **SESSION_ID 可能会过期**，如果生成失败，请重新获取
- **SESSION_ID 与账号绑定**，不同账号的SESSION_ID不同

---

## 🚀 启动即梦API服务

### 方式一：使用批处理脚本（推荐）

1. **双击运行** `启动即梦API服务.bat`

2. **脚本会自动执行以下操作**：
   - ✅ 停止占用3030端口的旧服务
   - ✅ 设置SESSION_ID环境变量
   - ✅ 启动即梦API服务

3. **成功启动的标志**：
   ```
   ============================================================
   启动即梦API服务（3030端口）
   ============================================================
   
   [步骤1] 停止占用3030端口的服务...
   [✓] 进程已停止
   
   [步骤2] 验证3030端口...
   [✓] 3030端口已释放
   
   [步骤3] 配置SESSION_ID...
   [✓] SESSION_ID已设置
   
   [步骤4] 启动即梦API服务...
   [端口] 3030
   [地址] http://localhost:3030
   ```

4. **保持窗口打开**，服务会持续运行

### 方式二：手动启动

1. **打开命令行**，进入项目目录

2. **进入即梦API目录**
   ```bash
   cd jimeng-api
   ```

3. **安装依赖**（首次运行）
   ```bash
   npm install
   ```

4. **构建项目**（首次运行）
   ```bash
   npm run build
   ```

5. **设置SESSION_ID环境变量**
   ```bash
   # Windows PowerShell
   $env:J_TOKEN="你的SESSION_ID"
   
   # Windows CMD
   set J_TOKEN=你的SESSION_ID
   
   # Linux/Mac
   export J_TOKEN="你的SESSION_ID"
   ```

6. **启动服务**
   ```bash
   npm start
   ```

### 验证服务是否启动成功

1. **打开浏览器**，访问: http://localhost:3030/health
2. **如果返回** `{"status":"ok"}` 或类似响应，说明服务启动成功

### ⚠️ 注意事项

- **不要关闭命令行窗口**，关闭窗口会停止服务
- **如果3030端口被占用**，脚本会自动尝试停止占用进程
- **如果自动停止失败**，请手动关闭占用3030端口的程序

---

## 🌐 启动前端网站

### 方式一：使用批处理脚本（推荐）

1. **双击运行** `启动项目.bat`

2. **等待启动完成**，看到以下信息：
   ```
   VITE v6.4.1  ready in 4849 ms
   
   ➜  Local:   http://localhost:3000/
   ➜  Network: http://192.168.1.172:3000/
   ```

3. **浏览器会自动打开** `http://localhost:3000`，如果没有，请手动访问

### 方式二：手动启动

1. **打开命令行**，进入项目根目录

2. **安装依赖**（首次运行）
   ```bash
   npm install
   ```

3. **启动开发服务器**
   ```bash
   npm run dev
   ```

4. **访问网站**
   - 打开浏览器，访问: http://localhost:3000

### ⚠️ 注意事项

- **3000端口必须可用**，如果被占用，请先停止占用进程
- **保持命令行窗口打开**，关闭窗口会停止网站
- **如果端口被占用**，Vite会报错而不是自动切换端口（已配置 `strictPort: true`）

---

## ⚙️ 配置即梦API

### 步骤1：进入媒体生成页面

1. 在网站首页，点击 **"媒体生成"** 或 **"Media Generator"** 标签

### 步骤2：选择即梦模型

1. 在 **"选择图片模型"** 下拉菜单中，选择 **"即梦 (Jimeng)"**

### 步骤3：配置API地址

1. 在 **"即梦 API 地址"** 输入框中，输入：
   ```
   http://localhost:3030
   ```
   - 这是即梦API服务的地址（默认已配置）

### 步骤4：配置SESSION_ID

1. 在 **"即梦 SESSION_ID"** 输入框中，粘贴您获取的SESSION_ID
   ```
   例如: 6eac93ccd72cf4372558f38ee2a3161a
   ```

2. **配置会自动保存**到浏览器本地存储，下次访问会自动加载

### 步骤5：验证配置

1. 输入一个简单的提示词，例如：`一只可爱的小猫`
2. 点击 **"生成图片"** 按钮
3. 如果配置正确，会看到生成的图片

### ⚠️ 常见配置错误

- ❌ **API地址错误**: 确保是 `http://localhost:3030`，不是 `http://localhost:3000`
- ❌ **SESSION_ID为空**: 确保已正确粘贴SESSION_ID，没有多余空格
- ❌ **服务未启动**: 确保即梦API服务正在运行（检查3030端口）

---

## 🎯 批量出图操作

### 场景一：单次生成多张图片

1. **进入媒体生成页面**
   - 选择即梦模型
   - 配置好API地址和SESSION_ID

2. **设置生成数量**
   - 在 **"生成数量"** 输入框中，输入要生成的图片数量（例如：`5`）

3. **输入提示词**
   - 在提示词输入框中输入您的描述

4. **选择图片尺寸**
   - 选择合适的宽高比（如：1:1、16:9、9:16等）

5. **点击生成**
   - 点击 **"生成图片"** 按钮
   - 系统会自动生成指定数量的图片

### 场景二：批量生成多个镜头的图片（脚本模式）

1. **进入脚本模式**
   - 在媒体生成页面，切换到 **"脚本模式"** 标签

2. **导入或创建脚本**
   - 可以导入已有的脚本文件
   - 或手动创建新的脚本内容

3. **配置镜头信息**
   - 每个镜头包含：
     - 镜头编号
     - 镜头描述
     - 图片提示词（`imagePrompt`）
     - 视频提示词（`videoPrompt`）

4. **批量生成图片**
   - 点击 **"批量生成圖片"** 按钮
   - 系统会为所有未生成图片的镜头批量生成图片

5. **查看生成进度**
   - 页面会显示批量生成进度
   - 每个镜头生成完成后会显示图片

6. **选择图片**
   - 如果某个镜头生成了多张图片，可以点击选择最满意的一张

### 场景三：批量导出图片

1. **选择要导出的镜头**
   - 在脚本模式中，勾选要导出的镜头（使用复选框）

2. **批量导出**
   - 点击 **"导出选中"** 按钮
   - 系统会将选中的图片打包为ZIP文件下载

### 📊 批量生成参数说明

#### 图片尺寸参数

即梦API使用 `ratio`（比例）和 `resolution`（分辨率）参数，系统会自动转换：

| 宽高比 | ratio值 | 说明 |
|--------|---------|------|
| 1:1 | `1:1` | 正方形 |
| 16:9 | `16:9` | 横屏 |
| 9:16 | `9:16` | 竖屏 |
| 4:3 | `4:3` | 标准横屏 |
| 3:4 | `3:4` | 标准竖屏 |
| 2:3 | `2:3` | 竖屏 |
| 3:2 | `3:2` | 横屏 |
| 21:9 | `21:9` | 超宽屏 |

#### 分辨率参数

| 最大尺寸 | resolution值 | 说明 |
|----------|--------------|------|
| ≤ 1200px | `1k` | 标准分辨率 |
| ≤ 2600px | `2k` | 高清分辨率 |
| > 2600px | `4k` | 超高清分辨率 |

### ⚡ 批量生成优化建议

1. **合理设置生成数量**
   - 单次生成建议不超过10张，避免超时
   - 批量生成时，系统会自动处理超时和重试

2. **使用描述性提示词**
   - 提示词越详细，生成效果越好
   - 可以包含风格、色彩、构图等描述

3. **选择合适的尺寸**
   - 根据用途选择合适的长宽比
   - 竖屏适合手机、社交媒体
   - 横屏适合电脑、视频

4. **保存重要配置**
   - SESSION_ID和API地址会自动保存
   - 建议定期检查SESSION_ID是否过期

---

## 🔍 常见问题排查

### 问题1：即梦API服务启动失败

**症状**：
- 运行 `启动即梦API服务.bat` 后立即退出
- 或显示端口被占用错误

**解决方案**：

1. **检查3030端口占用**
   ```bash
   netstat -ano | findstr ":3030"
   ```

2. **手动停止占用进程**
   ```bash
   taskkill /F /PID <进程ID>
   ```

3. **检查jimeng-api目录**
   - 确保 `jimeng-api` 目录存在
   - 确保已安装依赖：`cd jimeng-api && npm install`

4. **检查Node.js版本**
   ```bash
   node -v  # 应该是 v16 或更高版本
   ```

### 问题2：前端网站无法启动

**症状**：
- 运行 `启动项目.bat` 后显示端口被占用
- 或Vite报错 `Port 3000 is in use`

**解决方案**：

1. **检查3000端口占用**
   ```bash
   netstat -ano | findstr ":3000"
   ```

2. **停止占用进程**
   ```bash
   taskkill /F /PID <进程ID>
   ```

3. **检查vite.config.ts配置**
   - 确保 `port: 3000` 和 `strictPort: true` 已设置

### 问题3：图片生成失败 - "网络连接失败"

**症状**：
- 点击生成后显示 "网络连接失败"
- 或 "无法连接到即梦API服务"

**解决方案**：

1. **检查即梦API服务是否运行**
   - 访问: http://localhost:3030/health
   - 应该返回 `{"status":"ok"}`

2. **检查API地址配置**
   - 确保前端配置的地址是 `http://localhost:3030`
   - 不是 `http://localhost:3000`

3. **检查防火墙设置**
   - 确保Windows防火墙允许Node.js访问网络

### 问题4：图片生成失败 - "SESSION_ID 无效"

**症状**：
- 生成失败，提示 "SESSION_ID 无效" 或 "401 Unauthorized"

**解决方案**：

1. **重新获取SESSION_ID**
   - 按照 [获取SESSION_ID](#获取session_id) 章节重新获取
   - SESSION_ID可能已过期

2. **检查SESSION_ID格式**
   - 确保没有多余的空格
   - 确保完整复制了Cookie值

3. **验证SESSION_ID有效性**
   - 在即梦官网确认账号可以正常使用
   - 尝试在即梦官网生成一张图片，确认账号正常

### 问题5：图片生成失败 - "不支持的参数"

**症状**：
- 生成失败，提示 "不支持的参数: width, height"

**解决方案**：

1. **这个问题已自动处理**
   - 系统会自动将 `width`/`height` 转换为 `ratio`/`resolution`
   - 如果仍出现此错误，请检查 `services/jimengService.ts` 中的转换逻辑

2. **手动指定ratio和resolution**
   - 如果自动转换失败，可以在代码中手动指定
   - 参考 [批量生成参数说明](#批量生成参数说明)

### 问题6：批量生成部分失败

**症状**：
- 批量生成时，部分图片生成成功，部分失败

**解决方案**：

1. **查看错误信息**
   - 页面会显示每张图片的生成状态
   - 查看失败图片的具体错误信息

2. **常见原因**：
   - **网络超时**: 即梦API响应较慢，系统会自动重试
   - **SESSION_ID过期**: 重新获取SESSION_ID
   - **API限流**: 即梦API可能有请求频率限制，等待一段时间后重试

3. **重试失败图片**
   - 可以单独为失败的镜头重新生成
   - 或重新运行批量生成（已生成的会跳过）

### 问题7：生成的图片无法显示

**症状**：
- 生成成功，但图片无法加载或显示

**解决方案**：

1. **检查图片URL**
   - 右键图片 → "检查元素"
   - 查看图片URL是否可访问

2. **检查网络连接**
   - 即梦返回的图片URL可能需要外网访问
   - 确保网络可以访问即梦的CDN

3. **图片URL过期**
   - 即梦的图片URL可能有有效期
   - 建议及时下载保存图片

### 问题8：服务启动后立即退出

**症状**：
- 运行批处理脚本后，窗口立即关闭

**解决方案**：

1. **在命令行中运行**
   - 不要双击运行，而是在命令行中运行
   - 这样可以查看详细错误信息

2. **检查错误日志**
   - 查看 `jimeng-api/logs/` 目录下的日志文件
   - 查找错误信息

3. **检查依赖**
   - 进入 `jimeng-api` 目录
   - 运行 `npm install` 重新安装依赖

---

## 📝 快速检查清单

在开始批量出图前，请确认：

- [ ] Node.js 已安装（版本 16+）
- [ ] 已获取有效的 SESSION_ID
- [ ] 即梦API服务已启动（3030端口）
- [ ] 前端网站已启动（3000端口）
- [ ] 已配置即梦API地址：`http://localhost:3030`
- [ ] 已配置即梦SESSION_ID
- [ ] 已测试单张图片生成成功

---

## 🎉 开始使用

现在您已经完成了所有配置，可以开始批量出图了！

1. **单次生成多张**: 设置生成数量，输入提示词，点击生成
2. **批量生成脚本**: 导入脚本，点击"批量生成圖片"
3. **导出图片**: 选择镜头，点击"导出选中"

祝您使用愉快！如有问题，请参考 [常见问题排查](#常见问题排查) 章节。

---

## 📞 技术支持

如果遇到无法解决的问题：

1. **查看日志文件**
   - 即梦API服务日志: `jimeng-api/logs/`
   - 浏览器控制台: 按 `F12` 打开开发者工具

2. **检查配置文件**
   - 即梦API配置: `jimeng-api/configs/dev/service.yml`
   - 前端配置: `vite.config.ts`

3. **验证服务状态**
   - 即梦API健康检查: http://localhost:3030/health
   - 前端网站: http://localhost:3000

---

**最后更新**: 2026-01-20
**版本**: 1.0.0
